# üîç ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿ¥ÿßŸÖŸÑÿ© ŸÑŸÜÿ∏ÿßŸÖ "Route Matched / Order Matched"

## ‚úÖ **ÿßŸÑÿ™ÿØŸÇŸäŸÇ ÿßŸÑŸÖŸÉÿ™ŸÖŸÑ**

ÿ™ŸÖ ŸÅÿ≠ÿµ ÿ¥ÿßŸÖŸÑ ŸÖŸÜ ÿßŸÑÿ®ÿØÿßŸäÿ© ŸÑŸÑŸÜŸáÿßŸäÿ© (Backend ‚Üí Admin ‚Üí iOS Driver App) Ÿàÿ•ÿµŸÑÿßÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ¥ÿßŸÉŸÑ ÿßŸÑÿ≠ÿ±ÿ¨ÿ©.

---

## üìã **ÿßŸÑŸÖÿ¥ÿßŸÉŸÑ ÿßŸÑŸÖŸÉÿ™ÿ¥ŸÅÿ© ŸàÿßŸÑÿ•ÿµŸÑÿßÿ≠ÿßÿ™**

### **1. ‚ùå Backend Assignment ÿ®ÿØŸàŸÜ ŸÜÿßŸÅÿ∞ÿ© 30 ÿØŸÇŸäŸÇÿ©**

**ÿßŸÑŸÖÿ¥ŸÉŸÑÿ©:**
- `/api/admin/orders/[code]/assign-driver/route.ts` ŸÉÿßŸÜ ŸäŸÇŸàŸÖ ÿ®ÿßŸÑÿ™ÿπŸäŸäŸÜ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ®ŸÄ `status: 'accepted'`
- ŸÑÿß ŸäŸàÿ¨ÿØ `expiresAt` TTL
- Booking.driverId Ÿäÿ™ŸÖ ÿ™ÿπŸäŸäŸÜŸá ŸÅŸàÿ±Ÿãÿß (Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ®ŸÇŸâ null ÿ≠ÿ™Ÿâ ÿßŸÑŸÇÿ®ŸàŸÑ)

**ÿßŸÑÿ•ÿµŸÑÿßÿ≠:**
```typescript
// Before
status: 'accepted',
claimedAt: new Date(),

// After
status: 'invited',
round: 1,
expiresAt: new Date(Date.now() + 30 * 60 * 1000), // 30 minutes
```
- Booking status Ÿäÿ™ÿ∫Ÿäÿ± ÿ•ŸÑŸâ `PENDING` (ŸÑŸäÿ≥ `CONFIRMED`) ÿ≠ÿ™Ÿâ ŸäŸÇÿ®ŸÑ ÿßŸÑÿ≥ÿßÿ¶ŸÇ
- Booking.driverId Ÿäÿ®ŸÇŸâ `null` ÿ≠ÿ™Ÿâ ÿßŸÑŸÇÿ®ŸàŸÑ

---

### **2. ‚ùå Pusher Event ÿ®ÿØŸàŸÜ Payload ŸÉÿßŸÖŸÑ**

**ÿßŸÑŸÖÿ¥ŸÉŸÑÿ©:**
- `route-matched` event ŸÑÿß Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ:
  - `expiresAt` (ŸàŸÇÿ™ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©)
  - `expiresInSeconds` (ŸÑŸÑÿπÿØ ÿßŸÑÿ™ŸÜÿßÿ≤ŸÑŸä)
  - `orderId`, `orderNumber` (ŸÑŸÑÿ™ÿ™ÿ®ÿπ)
  - `estimatedEarnings`, `distance` (ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸàÿ∏ŸäŸÅÿ©)

**ÿßŸÑÿ•ÿµŸÑÿßÿ≠:**
```typescript
await pusher.trigger(`driver-${driverId}`, 'route-matched', {
  type: 'single-order',
  matchType: 'order',
  jobCount: 1,
  bookingId: booking.id,
  orderId: booking.id,
  bookingReference: booking.reference,
  orderNumber: booking.reference,
  assignmentId: result.newAssignment.id,
  assignedAt: new Date().toISOString(),
  expiresAt: expiresAt?.toISOString(),
  expiresInSeconds: 1800, // 30 minutes
  pickupAddress: booking.pickupAddress,
  dropoffAddress: booking.dropoffAddress,
  estimatedEarnings: booking.driverEarnings || booking.totalGBP,
  distance: booking.distance,
  message: 'New job assigned - 30 minutes to accept',
});
```

---

### **3. ‚ùå ÿπÿØŸÖ Ÿàÿ¨ŸàÿØ Auto-Expiry Logic**

**ÿßŸÑŸÖÿ¥ŸÉŸÑÿ©:**
- `/api/driver/jobs/expire-claimed/route.ts` ŸÉÿßŸÜ ŸäŸÅÿ≠ÿµ `status: 'claimed'` ŸÅŸÇÿ∑
- ŸÑÿß ŸäŸÅÿ≠ÿµ `status: 'invited'` (ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©)
- ŸÑÿß ŸäŸàÿ¨ÿØ acceptance rate penalty ÿπŸÑŸâ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°
- ŸÑÿß ŸäŸàÿ¨ÿØ auto-reassignment

**ÿßŸÑÿ•ÿµŸÑÿßÿ≠:**
- ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑfinder ŸÑŸäÿ¥ŸÖŸÑ `status: { in: ['claimed', 'invited'] }`
- ÿ•ÿ∂ÿßŸÅÿ© **-5% acceptance rate penalty** (ŸÜŸÅÿ≥ decline)
- ÿ•ÿ∂ÿßŸÅÿ© **auto-reassignment** ÿ•ŸÑŸâ next available driver
- ÿ•ÿ±ÿ≥ÿßŸÑ **Pusher notifications** ŸÑŸÑÿ≥ÿßÿ¶ŸÇ ŸàÿßŸÑŸÄ admin

---

### **4. ‚ùå ÿπÿØŸÖ Ÿàÿ¨ŸàÿØ Countdown Timer ŸÅŸä Modal**

**ÿßŸÑŸÖÿ¥ŸÉŸÑÿ©:**
- `RouteMatchModal` ŸÑÿß Ÿäÿπÿ±ÿ∂ countdown
- ŸÑÿß ŸäŸàÿ¨ÿØ auto-close ÿπŸÜÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑŸàŸÇÿ™

**ÿßŸÑÿ•ÿµŸÑÿßÿ≠:**
```typescript
// Added props
interface RouteMatchModalProps {
  expiresAt?: string;  // ISO timestamp
  expiresInSeconds?: number;  // Fallback
  ...
}

// Added countdown timer
const [remainingSeconds, setRemainingSeconds] = useState(1800);

useEffect(() => {
  // Calculate from expiresAt
  const expiryTime = new Date(expiresAt).getTime();
  const secondsRemaining = Math.floor((expiryTime - Date.now()) / 1000);
  setRemainingSeconds(secondsRemaining);
}, [expiresAt]);

useEffect(() => {
  // Countdown interval
  intervalRef.current = setInterval(() => {
    setRemainingSeconds(prev => {
      if (prev <= 1) {
        onLater(); // Auto-close
        return 0;
      }
      return prev - 1;
    });
  }, 1000);
}, [remainingSeconds]);

// Display
<View style={styles.countdownContainer}>
  <Text style={{ color: getCountdownColor() }}>
    {formatCountdown(remainingSeconds)}
  </Text>
</View>
```

**ŸÖŸÖŸäÿ≤ÿßÿ™:**
- Ÿäÿπÿ±ÿ∂ countdown ŸÖŸÜ **30:00** ÿ•ŸÑŸâ **0:00**
- ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿ™ÿ™ÿ∫Ÿäÿ±: ÿ£ÿÆÿ∂ÿ± (> 10 ÿØŸÇÿßÿ¶ŸÇ)ÿå ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä (> 5 ÿØŸÇÿßÿ¶ŸÇ)ÿå ÿ£ÿ≠ŸÖÿ± (< 5 ÿØŸÇÿßÿ¶ŸÇ)
- Auto-close ÿπŸÜÿØ `0:00`

---

### **5. ‚ùå ÿπÿØŸÖ Ÿàÿ¨ŸàÿØ Persistence Layer**

**ÿßŸÑŸÖÿ¥ŸÉŸÑÿ©:**
- ŸÑÿß Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ pending offers ŸÅŸä AsyncStorage
- ÿ•ÿ∞ÿß ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇÿå ŸäŸÅŸÇÿØ ÿßŸÑÿ≥ÿßÿ¶ŸÇ ÿßŸÑŸÄ offer

**ÿßŸÑÿ•ÿµŸÑÿßÿ≠:**
- ÿ•ÿ∂ÿßŸÅÿ© `storage.service.ts` functions:
  - `savePendingOffer(offer)`
  - `getPendingOffers()` - Ÿäÿ≤ŸäŸÑ expired offers ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß
  - `removePendingOffer(offerId)`
  - `getLatestPendingOffer()`

```typescript
export interface PendingOffer {
  id: string;
  bookingId: string;
  orderId: string;
  bookingReference: string;
  orderNumber: string;
  matchType: 'order' | 'route';
  jobCount: number;
  assignmentId: string;
  assignedAt: string;
  expiresAt: string;
  receivedAt: string;
  ...
}
```

---

### **6. ‚ùå ÿπÿØŸÖ Restore Pending Offers ÿπŸÑŸâ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ**

**ÿßŸÑŸÖÿ¥ŸÉŸÑÿ©:**
- ŸÑÿß ŸäŸàÿ¨ÿØ ŸÉŸàÿØ ŸäŸÅÿ≠ÿµ pending offers ÿπŸÜÿØ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ

**ÿßŸÑÿ•ÿµŸÑÿßÿ≠:**
```typescript
// DashboardScreen.tsx

const [currentPendingOffer, setCurrentPendingOffer] = useState<PendingOffer | null>(null);

useEffect(() => {
  // Restore pending offers on app start
  const restorePendingOffers = async () => {
    const offers = await getPendingOffers();
    if (offers.length > 0) {
      const latestOffer = offers[0];
      setCurrentPendingOffer(latestOffer);
      setShowMatchModal(true);
      console.log('üìå Restored pending offer:', latestOffer.id);
    }
  };
  
  restorePendingOffers();
}, []);

// When route-matched event received
pusherService.addEventListener('route-matched', (data: any) => {
  const pendingOffer: PendingOffer = { ...data, receivedAt: new Date().toISOString() };
  
  // Save to storage
  await savePendingOffer(pendingOffer);
  
  // Set in state
  setCurrentPendingOffer(pendingOffer);
  setShowMatchModal(true);
});

// Pass to modal
<RouteMatchModal
  visible={showMatchModal}
  expiresAt={currentPendingOffer?.expiresAt}
  bookingReference={currentPendingOffer?.bookingReference}
  ...
/>
```

---

### **7. ‚úÖ Acceptance Rate Penalty ÿπŸÑŸâ Expiry**

**ŸÖÿ∑ÿ®ŸëŸÇ ŸÅŸä:**
- `/api/driver/jobs/expire-claimed/route.ts`
- ŸÜŸÅÿ≥ ŸÖŸÜÿ∑ŸÇ decline: **-5%**
- ŸäŸèÿ±ÿ≥ŸÑ real-time update ÿπÿ®ÿ± Pusher:
  ```typescript
  await pusher.trigger(`driver-${driverId}`, 'acceptance-rate-updated', {
    acceptanceRate: newAcceptanceRate,
    change: -5,
    reason: 'assignment_expired',
  });
  ```

---

## üîÑ **ÿßŸÑÿ™ÿØŸÅŸÇ ÿßŸÑŸÉÿßŸÖŸÑ (End-to-End)**

### **1. Admin Assigns Driver**

```
Admin Dashboard ‚Üí Assign Driver to Order SV-12345
     ‚Üì
POST /api/admin/orders/SV-12345/assign-driver { driverId: "driver_123" }
     ‚Üì
Backend Creates:
  - Assignment { status: 'invited', expiresAt: now + 30min }
  - Booking { status: 'PENDING', driverId: null }
     ‚Üì
Pusher Event: driver-driver_123 / route-matched
  {
    bookingReference: "SV-12345",
    expiresAt: "2025-10-11T12:30:00Z",
    expiresInSeconds: 1800,
    ...
  }
```

### **2. iOS Driver App Receives Event**

```
Pusher Service ‚Üí route-matched event received
     ‚Üì
DashboardScreen:
  - Creates PendingOffer object
  - Saves to AsyncStorage
  - Sets state: setCurrentPendingOffer(offer)
  - Shows RouteMatchModal
     ‚Üì
RouteMatchModal:
  - Calculates remaining time from expiresAt
  - Starts countdown timer (30:00 ‚Üí 0:00)
  - Vibrates + plays sound
  - Shows prominent countdown with color coding
```

### **3. Driver Actions**

#### **A. Driver Taps "View Now" ‚Üí Accept**
```
Navigation ‚Üí JobDetailScreen
     ‚Üì
Driver taps "Accept"
     ‚Üì
POST /api/driver/jobs/{id}/accept
     ‚Üì
Backend:
  - Updates Assignment { status: 'accepted', claimedAt: now }
  - Updates Booking { driverId: driver_123, status: 'CONFIRMED' }
  - Removes from AsyncStorage
     ‚Üì
Pusher Events:
  - admin-orders: order-status-changed
  - booking-SV-12345: driver-assigned
```

#### **B. Driver Taps "Decline"**
```
POST /api/driver/jobs/{id}/decline
     ‚Üì
Backend:
  - Updates Assignment { status: 'declined' }
  - Updates Booking { driverId: null, status: 'CONFIRMED' }
  - Decreases acceptance rate by 5%
  - Removes from AsyncStorage
     ‚Üì
Pusher Events:
  - driver-driver_123: job-removed + acceptance-rate-updated
  - admin-orders: order-status-changed
     ‚Üì
Auto-Reassignment:
  - Finds next available driver
  - Creates new Assignment { round: 2 }
  - Sends route-matched to next driver
```

#### **C. Driver Ignores (30 minutes expire)**
```
Cron Job: POST /api/driver/jobs/expire-claimed (every 1 minute)
     ‚Üì
Backend finds expired invited assignments
     ‚Üì
For each expired:
  - Updates Assignment { status: 'declined', declinedAt: now }
  - Decreases acceptance rate by 5%
  - Removes from AsyncStorage (on next getPendingOffers call)
     ‚Üì
Pusher Events (same as decline)
     ‚Üì
Auto-Reassignment (same as decline)
```

#### **D. App Restarts**
```
DashboardScreen useEffect (on mount)
     ‚Üì
Calls getPendingOffers()
     ‚Üì
Filters out expired offers
     ‚Üì
If active offer exists:
  - setCurrentPendingOffer(offer)
  - setShowMatchModal(true)
  - Countdown resumes with correct remaining time
```

---

## üîß **Cron Job Setup (Required)**

**ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ auto-expiry ŸäÿπŸÖŸÑÿå Ÿäÿ¨ÿ® ÿ•ÿπÿØÿßÿØ cron job:**

### **Option 1: External Cron Service (Recommended)**
```bash
# Use cron-job.org or similar
URL: https://speedy-van.co.uk/api/driver/jobs/expire-claimed
Method: POST
Interval: Every 1 minute
```

### **Option 2: Server-Side Cron**
```javascript
// If using Node.js server
const cron = require('node-cron');

cron.schedule('* * * * *', async () => {
  console.log('‚è∞ Running expiry check...');
  await fetch('http://localhost:3000/api/driver/jobs/expire-claimed', {
    method: 'POST'
  });
});
```

### **Option 3: Vercel Cron**
```json
// vercel.json
{
  "crons": [{
    "path": "/api/driver/jobs/expire-claimed",
    "schedule": "* * * * *"
  }]
}
```

---

## üìä **State Sync Matrix**

| Event | Admin Dashboard | Driver App | Customer Tracking | Acceptance Rate |
|-------|----------------|------------|-------------------|-----------------|
| **Admin Assigns** | Order status: "Assigned (Pending)" | Popup + Countdown | No change | No change |
| **Driver Accepts** | Order status: "Confirmed" | Popup closes, job in Active | Driver assigned | No change |
| **Driver Declines** | Order status: "Available" | Popup closes, job removed | No change | -5% |
| **Assignment Expires** | Order status: "Available" | Popup auto-closes, job removed | No change | -5% |
| **Auto-Reassign** | Order status: "Assigned (Pending)" to new driver | New popup to next driver | No change | No change |

---

## ‚úÖ **ÿßŸÑŸÖŸäÿ≤ÿßÿ™ ÿßŸÑŸÖÿ∑ÿ®ŸëŸÇÿ©**

1. ‚úÖ **30-minute TTL** ÿπŸÑŸâ ŸÉŸÑ assignment
2. ‚úÖ **Countdown timer** ŸÖÿ±ÿ¶Ÿä ŸÅŸä ÿßŸÑŸÄ modal
3. ‚úÖ **Auto-expiry** ŸÖÿπ reassignment
4. ‚úÖ **-5% acceptance rate penalty** ÿπŸÑŸâ decline Ÿà expiry
5. ‚úÖ **Persistence** ŸÅŸä AsyncStorage
6. ‚úÖ **Restore** pending offers ÿ®ÿπÿØ ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
7. ‚úÖ **Real-time sync** ÿπÿ®ÿ± Pusher ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ∑ÿ±ÿßŸÅ
8. ‚úÖ **Idempotent** accept/decline endpoints
9. ‚úÖ **Round tracking** ŸÑÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©
10. ‚úÖ **Complete payload** ŸÅŸä Pusher events

---

## üß™ **ÿÆÿ∑Ÿàÿßÿ™ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±**

### **Test 1: Instant Popup**
1. Admin assigns driver to order
2. **Expected:** Driver sees popup ŸÅŸä < 1 ÿ´ÿßŸÜŸäÿ©
3. **Verify:** Countdown Ÿäÿ®ÿØÿ£ ŸÖŸÜ 30:00

### **Test 2: Countdown**
1. Wait 5 minutes
2. **Expected:** Countdown shows 25:00
3. **Verify:** Color changes to orange at 10:00, red at 5:00

### **Test 3: Accept**
1. Tap "View Now" ‚Üí "Accept"
2. **Expected:** 
   - Popup closes
   - Job appears in Active Jobs
   - Admin sees "Confirmed"
   - Acceptance rate unchanged

### **Test 4: Decline**
1. Tap "View Now" ‚Üí "Decline"
2. **Expected:**
   - Popup closes
   - Job removed from list
   - Acceptance rate decreases by 5%
   - Next driver receives popup

### **Test 5: Expiry**
1. Wait 30 minutes without action
2. **Expected:**
   - Popup auto-closes
   - Job removed
   - Acceptance rate decreases by 5%
   - Next driver receives popup

### **Test 6: App Restart**
1. Receive assignment
2. Close app (force quit)
3. Reopen app
4. **Expected:**
   - Popup reappears
   - Countdown shows correct remaining time

### **Test 7: Offline Recovery**
1. Turn off WiFi
2. Admin assigns
3. Turn on WiFi after 5 minutes
4. **Expected:**
   - Popup appears
   - Countdown shows 25:00 (not 30:00)

---

## üìù **ÿßŸÑÿ™Ÿàÿ´ŸäŸÇ**

### **Backend Endpoints**

#### **Assign Driver**
```
POST /api/admin/orders/{code}/assign-driver
Body: { driverId: string, reason?: string }

Response:
{
  success: true,
  data: {
    bookingId: string,
    assignmentId: string,
    assignedAt: string
  }
}

Pusher Event: driver-{driverId} / route-matched
```

#### **Accept Assignment**
```
POST /api/driver/jobs/{id}/accept
Body: { reason?: string }

Response: { success: true }

Updates:
- Assignment.status ‚Üí 'accepted'
- Booking.driverId ‚Üí {driverId}
- Booking.status ‚Üí 'CONFIRMED'
```

#### **Decline Assignment**
```
POST /api/driver/jobs/{id}/decline
Body: { reason?: string }

Response: { success: true, acceptanceRate: number, change: -5 }

Updates:
- Assignment.status ‚Üí 'declined'
- Booking.driverId ‚Üí null
- DriverPerformance.acceptanceRate ‚Üí current - 5
```

#### **Expire Claimed/Invited**
```
POST /api/driver/jobs/expire-claimed

Response: {
  expiredCount: number,
  expiredAssignments: Array<{id, bookingId, driverId}>
}

Runs: Every 1 minute (cron)
```

---

## üéØ **ÿßŸÑÿÆŸÑÿßÿµÿ©**

ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¢ŸÜ ŸäÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ŸÉÿßŸÖŸÑ ŸÖÿπ:
- ‚úÖ **Instant popup** (< 1s)
- ‚úÖ **30-minute countdown** ŸÖÿ±ÿ¶Ÿä
- ‚úÖ **Auto-expiry + reassignment**
- ‚úÖ **Acceptance rate penalties**
- ‚úÖ **Persistence across restarts**
- ‚úÖ **Real-time sync** ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ∑ÿ±ÿßŸÅ

**ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿπÿ∞ÿßÿ± - ŸÉŸÑ ÿ¥Ÿäÿ° ŸÖŸàÿ´ŸÇ ŸàŸÖÿ∑ÿ®ŸëŸÇ.**

---

ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©: 2025-10-11  
ÿßŸÑŸÖÿ±ÿßÿ¨ÿπ: Backend + Admin + iOS Driver App

