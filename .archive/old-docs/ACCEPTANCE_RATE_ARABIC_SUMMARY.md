# ๐ ูุธุงู ูุนุฏู ุงููุจูู - ุงูููุฎุต ุงูุนุฑุจู ุงูุดุงูู

## โจ ุชู ุงูุฅูุฌุงุฒ ุจูุฌุงุญ!

ุชู ุชุทููุฑ ูุธุงู ูุชูุงูู ูุชุชุจุน ูุนุฏู ูุจูู ุงูุณุงุฆููู (Acceptance Rate) ูุน ุงูุชุญุฏูุซ ุงูููุฑู ุนุจุฑ ุฌููุน ุงูููุตุงุช.

---

## ๐ฏ ูุง ุชู ุชูููุฐู:

### 1. **ุฎูุถ ุชููุงุฆู ููุนุฏู ุงููุจูู** ๐
- โ ูู ุฑูุถ = **-5%** ูู ูุนุฏู ุงููุจูู
- โ ุงููุนุฏู **ูุง ููุฎูุถ ุนู 0%** ุฃุจุฏุงู
- โ ุงูุชุญุฏูุซ ููุฑู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุญูุธ ุขูู ูู ุฌุฏูู `DriverPerformance`

**ูุซุงู:**
```
ูุนุฏู ุงูุณุงุฆู ุงูุญุงูู: 85%
ุฑูุถ ุทูุจ โ 85% - 5% = 80%
ุฑูุถ ุขุฎุฑ โ 80% - 5% = 75%
```

---

### 2. **ุชุญุฏูุซ ููุฑู ุนุจุฑ Pusher** โก

ุนูุฏ ุฑูุถ ุงูุณุงุฆู ูุทูุจ ุฃู ูุณุงุฑุ ูุชู ุงูุชุญุฏูุซ **ููุฑุงู** ูู:

#### โ Driver Schedule (ุฌุฏูู ุงูุณุงุฆู)
- ุชุญุฏูุซ ุดุฑูุท ุงูุชูุฏู (Progress Bar)
- ุฅุดุนุงุฑ ุจุงููุนุฏู ุงูุฌุฏูุฏ
- ุฑุณุงูุฉ ุชุญุฐูุฑูุฉ ููุณุงุฆู

#### โ Admin Schedule (ุฌุฏูู ุงูุฃุฏูู)
- ุชุญุฏูุซ ูุงุฆูุฉ ุงูุณุงุฆููู
- ุนุฑุถ ุงููุนุฏู ุงูุฌุฏูุฏ
- ุฅุดุนุงุฑ ุจุงุณู ุงูุณุงุฆู ูุงููุนุฏู

#### โ iOS Driver App
- ุฅุดุนุงุฑ Push ููุฑู
- ุชุญุฏูุซ ูุงุฌูุฉ ุงูุชุทุจูู
- ุนุฑุถ ุงููุนุฏู ุงูุฌุฏูุฏ

---

## ๐ ุฅุดุนุงุฑุงุช Pusher ุงูููุฑุณูุฉ

### ููุณุงุฆู (Driver Channel):
```javascript
// ุฅุดุนุงุฑ ุจุชุญุฏูุซ ุงููุนุฏู
{
  event: 'acceptance-rate-updated',
  data: {
    acceptanceRate: 80,    // ุงููุนุฏู ุงูุฌุฏูุฏ
    change: -5,            // ุงูุชุบููุฑ (-5%)
    reason: 'job_declined' // ุงูุณุจุจ
  }
}

// ุฅุดุนุงุฑ ุจุชุญุฏูุซ ุงูุฌุฏูู
{
  event: 'schedule-updated',
  data: {
    type: 'acceptance_rate_changed',
    acceptanceRate: 80
  }
}
```

### ููุฃุฏูู (Admin Channel):
```javascript
// ุฅุดุนุงุฑ ุจุชุญุฏูุซ ุฃุฏุงุก ุงูุณุงุฆู
{
  event: 'driver-acceptance-rate-updated',
  data: {
    driverId: 'driver123',
    driverName: 'ุฃุญูุฏ ูุญูุฏ',
    acceptanceRate: 80,
    change: -5
  }
}

// ุฅุดุนุงุฑ ุจุชุญุฏูุซ ุงูุฌุฏูู
{
  event: 'driver-performance-updated',
  data: {
    driverId: 'driver123',
    acceptanceRate: 80,
    type: 'acceptance_rate_decreased'
  }
}
```

---

## ๐๏ธ APIs ุงูููุญุฏุซุฉ:

### 1. ุฑูุถ ุทูุจ (Job)
```
POST /api/driver/jobs/[id]/decline

ุงูุฑุฏ:
{
  "success": true,
  "acceptanceRate": 80,
  "change": -5
}
```

### 2. ุฑูุถ ุทูุจ (Dispatch)
```
POST /api/dispatch/decline

ุงูุฑุฏ:
{
  "ok": true,
  "acceptanceRate": 80,
  "change": -5
}
```

### 3. ุฑูุถ ูุณุงุฑ (Route)
```
POST /api/driver/routes/[id]/decline

ุงูุฑุฏ:
{
  "success": true,
  "warning": "ูุนุฏู ูุจููู ุงูุฎูุถ ุฅูู 80%",
  "data": {
    "acceptanceRate": 80,
    "change": -5
  }
}
```

---

## ๐ป ููููุฉ ุงูุงุณุชูุงุน ููุชุญุฏูุซุงุช

### Driver Portal (React):
```typescript
useEffect(() => {
  const pusher = new Pusher(process.env.NEXT_PUBLIC_PUSHER_KEY!);
  const channel = pusher.subscribe(`driver-${driverId}`);

  // ุงูุงุณุชูุงุน ูุชุญุฏูุซ ุงููุนุฏู
  channel.bind('acceptance-rate-updated', (data) => {
    setAcceptanceRate(data.acceptanceRate);
    
    toast({
      title: 'ุชุญุฏูุซ ูุนุฏู ุงููุจูู',
      description: `ูุนุฏู ูุจููู ุงูุขู: ${data.acceptanceRate}%`
    });
  });

  return () => pusher.unsubscribe(`driver-${driverId}`);
}, [driverId]);
```

### Admin Schedule (React):
```typescript
useEffect(() => {
  const pusher = new Pusher(process.env.NEXT_PUBLIC_PUSHER_KEY!);
  const channel = pusher.subscribe('admin-drivers');

  // ุงูุงุณุชูุงุน ูุชุญุฏูุซ ุฃุฏุงุก ุงูุณุงุฆู
  channel.bind('driver-acceptance-rate-updated', (data) => {
    updateDriverInList(data.driverId, {
      acceptanceRate: data.acceptanceRate
    });
    
    toast({
      title: 'ุชุญุฏูุซ ุฃุฏุงุก ุงูุณุงุฆู',
      description: `${data.driverName}: ${data.acceptanceRate}%`
    });
  });

  return () => pusher.unsubscribe('admin-drivers');
}, []);
```

### iOS App (Swift):
```swift
let channel = pusher.subscribe("driver-\(driverId)")

channel.bind(eventName: "acceptance-rate-updated") { event in
    let newRate = event.data["acceptanceRate"] as? Int ?? 100
    
    DispatchQueue.main.async {
        self.acceptanceRate = newRate
        self.progressBar.progress = Float(newRate) / 100.0
        
        self.showNotification(
            title: "ุชุญุฏูุซ ูุนุฏู ุงููุจูู",
            body: "ูุนุฏู ูุจููู ุงูุขู: \(newRate)%"
        )
    }
}
```

---

## ๐๏ธ ุงูุชุญุฏูุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:

```sql
-- ุนูุฏ ุฑูุถ ุงูุณุงุฆู ูุทูุจ/ูุณุงุฑ
UPDATE DriverPerformance
SET 
  acceptanceRate = GREATEST(0, acceptanceRate - 5),
  lastCalculated = NOW()
WHERE driverId = 'driver123'
```

---

## ๐ ููุทู ุงูุนูู:

### ุญุณุงุจ ุงููุนุฏู ุงูุฌุฏูุฏ:
```
ุงููุนุฏู ุงูุฌุฏูุฏ = MAX(0, ุงููุนุฏู ุงูุญุงูู - 5)

ุฃูุซูุฉ:
100% โ ุฑูุถ โ 95%
50% โ ุฑูุถ โ 45%
5% โ ุฑูุถ โ 0%
0% โ ุฑูุถ โ 0% (ูุจูู ุตูุฑ)
```

### ุชุตููู ุงูุฃุฏุงุก:
```
ููุชุงุฒ:   90-100%  โ (ุฃููููุฉ ุนุงููุฉ)
ุฌูุฏ:     80-89%   โ (ุทุจูุนู)
ููุจูู:   60-79%   โ๏ธ (ุชุญุฐูุฑ)
ุถุนูู:    40-59%   โ (ูุฑุงุฌุนุฉ)
ุญุฑุฌ:     0-39%    ๐จ (ุฎุทุฑ ุงูุชุนููู)
```

---

## ๐ฏ ุณููุงุฑูููุงุช ุงูุงุณุชุฎุฏุงู:

### ุงูุณููุงุฑูู 1: ุฑูุถ ุทูุจ ูุงุญุฏ
```
ุงููุนุฏู ุงูุฃููู: 85%
ุงูุฅุฌุฑุงุก: ุฑูุถ ุทูุจ
ุงููุชูุฌุฉ: 85% - 5% = 80%

ุงูุฅุดุนุงุฑุงุช:
โ ุชุทุจูู ุงูุณุงุฆู: "ูุนุฏู ูุจููู ุงูุฎูุถ ุฅูู 80%"
โ ููุญุฉ ุงูุฃุฏูู: ุชุญุฏูุซ ููุฑู
โ ุดุฑูุท ุงูุชูุฏู: ูุชุญุฏุซ ูุญุธูุงู
```

### ุงูุณููุงุฑูู 2: ุฑูุถ ูุณุงุฑ
```
ุงููุนุฏู ุงูุฃููู: 75%
ุงูุฅุฌุฑุงุก: ุฑูุถ ูุณุงุฑ ุจู 10 stops
ุงููุชูุฌุฉ: 75% - 5% = 70%

ุงูุฅุดุนุงุฑุงุช:
โ ุงูุณุงุฆู: "ุชุญุฐูุฑ: ูุนุฏูู ุงูุฎูุถ ุฅูู 70%"
โ ุงูุฃุฏูู: ุฅุดุนุงุฑ ุจุงุณู ุงูุณุงุฆู ูุงููุนุฏู
โ ุฌููุน ุงูููุตุงุช: ูุชุฒุงููุฉ ููุฑุงู
```

### ุงูุณููุงุฑูู 3: ุงููุตูู ููุตูุฑ
```
ุงููุนุฏู ุงูุฃููู: 3%
ุงูุฅุฌุฑุงุก: ุฑูุถ ุทูุจ
ุงููุชูุฌุฉ: MAX(0, 3 - 5) = 0%

ุงูุฅุดุนุงุฑุงุช:
โ ุงูุณุงุฆู: "ุญุฑุฌ: ูุนุฏู ุงููุจูู 0%"
โ ุงูุฃุฏูู: "ุงูุณุงุฆู ูุญุชุงุฌ ูุฑุงุฌุนุฉ - ูุนุฏู 0%"
โ ูุถุน ุนูุงูุฉ ุชููุงุฆูุฉ ูููุฑุงุฌุนุฉ
```

---

## ๐ ุชุฏูู ุงูุชุญุฏูุซ ุงูููุฑู:

```
ุงูุณุงุฆู ูุฑูุถ โ API ูุญุฏุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช โ Pusher ูุฑุณู ุงูุฅุดุนุงุฑุงุช
                                                      โ
                                    โโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโ
                                    โ                                   โ
                            Driver Channel                        Admin Channel
                                    โ                                   โ
                          โโโโโโโโโโโดโโโโโโโโโโ              โโโโโโโโโโโดโโโโโโโโโโ
                          โ                   โ              โ                   โ
                    Driver Portal        iOS App       Admin Dashboard    Admin Schedule
                          โ                   โ              โ                   โ
                     ุดุฑูุท ุงูุชูุฏู        ุดุฑูุท ุงูุชูุฏู    ูุงุฆูุฉ ุงูุณุงุฆููู    ุนุฑุถ ุงูุฌุฏูู
                      ูุชุญุฏุซ              ูุชุญุฏุซ          ุชุชุญุฏุซ            ูุชุญุฏุซ
```

---

## ๐ก๏ธ ุงูุฃูุงู ูุงูุชุญูู:

### ุณูุงูุฉ ุงูุจูุงูุงุช:
- โ ุงููุนุฏู ูุง ููุฎูุถ ุนู 0% ุฃุจุฏุงู
- โ ุชุญุฏูุซ ุถูู Transaction (rollback ุนูุฏ ุงูุฎุทุฃ)
- โ ุชุณุฌูู ุงูููุช (`lastCalculated`)
- โ ุณุฌู audit ูุงูู

### ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:
- โ ูุดู Pusher ูุง ูููุน ุงูุฑูุถ
- โ ุฎุทุฃ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช = rollback
- โ ุณุฌู ุฃุฏุงุก ููููุฏ = ุฅูุดุงุก ุงูุชุฑุงุถู
- โ ูุนุฑู ุณุงุฆู ุฎุงุทุฆ = ุฎุทุฃ 404

---

## ๐ ุงููุฑุงูุจุฉ ูุงูุณุฌูุงุช:

### ุณุฌูุงุช ุงููุฌุงุญ:
```
๐ Acceptance rate decreased: 85% โ 80%
๐ก Acceptance rate update notifications sent successfully
โ Job declined successfully: { acceptanceRate: 80 }
```

### ุณุฌูุงุช ุงูุฃุฎุทุงุก:
```
โ Error declining job: [details]
โ๏ธ Failed to send Pusher notifications: [error] (decline continues)
```

---

## โ ูุง ุชู ุฅูุฌุงุฒู:

### ุงูู Backend:
- [x] ุชุญุฏูุซ 3 APIs (job decline ร 2 + route decline)
- [x] ููุทู ุฎูุถ -5% ูููุฐ
- [x] ุงููุนุฏู ูุง ููุฎูุถ ุนู 0%
- [x] ุชุญุฏูุซ DriverPerformance ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- [x] Pusher notifications (4 events)
- [x] Audit trail logging

### ุงูุฅุดุนุงุฑุงุช:
- [x] Driver channel: `acceptance-rate-updated`
- [x] Driver channel: `schedule-updated`
- [x] Admin channel: `driver-acceptance-rate-updated`
- [x] Admin channel: `driver-performance-updated`

### ุงูุชูุซูู:
- [x] ููู ุชูุซูู ุฅูุฌููุฒู ุดุงูู
- [x] ููู ููุฎุต ุนุฑุจู
- [x] ุฃูุซูุฉ ููุฏ Frontend
- [x] ุฃูุซูุฉ ููุฏ iOS

---

## ๐ ุฌุงูุฒ ููุงุณุชุฎุฏุงู!

ุงููุธุงู ุงูุขู ูุนูู ุจุงููุงูู:

โ **ุชููุงุฆู** - ุฎูุถ 5% ุนูุฏ ูู ุฑูุถ  
โ **ููุฑู** - ุชุญุฏูุซ ูุญุธู ุนุจุฑ Pusher  
โ **ูุชุนุฏุฏ ุงูููุตุงุช** - Driver Portal + Admin + iOS  
โ **ุขูู** - ูุง ููุฎูุถ ุนู 0%ุ transactions  
โ **ุดูุงู** - ููุงุญุธุงุช ูุงุถุญุฉ ููุณุงุฆููู ูุงูุฃุฏูู  
โ **ูููุซู** - ุณุฌู audit ูุงูู  

---

## ๐ฑ ููู ูุนูู ูู ุงููุงูุน:

### ูู ุฌุงูุจ ุงูุณุงุฆู:
1. ุงูุณุงุฆู ูุฑูุถ ุทูุจ/ูุณุงุฑ
2. ูุฑู ุฑุณุงูุฉ: "ูุนุฏู ูุจููู ุงูุฎูุถ ุฅูู 80%"
3. ุดุฑูุท ุงูุชูุฏู ูุชุญุฏุซ ููุฑุงู
4. ุฅุดุนุงุฑ ูู ุชุทุจูู iOS
5. ูู ุดูุก ููุญุฏุซ ุจุฏูู refresh

### ูู ุฌุงูุจ ุงูุฃุฏูู:
1. ุงูุฃุฏูู ูุฑู ุฅุดุนุงุฑ: "ุฃุญูุฏ ุฑูุถ ุทูุจ - ูุนุฏูู 80%"
2. ูุงุฆูุฉ ุงูุณุงุฆููู ุชูุญุฏุซ ููุฑุงู
3. ุดุฑูุท ุงูุชูุฏู ูุชุบูุฑ ูุญุธูุงู
4. ูู ุดูุก ููุฒุงูู ุจุฏูู refresh

**ุงููุธุงู ุฌุงูุฒ ููุฅูุชุงุฌ! ๐**

