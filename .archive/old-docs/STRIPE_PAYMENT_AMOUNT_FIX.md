# โ ุฅุตูุงุญ ูุดููุฉ ุงูุณุนุฑ ูู ุฑุณุงุฆู ุงูุชุฃููุฏ

## ๐ ุงููุดููุฉ ุงูููุชุดูุฉ

ูุงู ููุงู ุงุฎุชูุงู ุจูู:
- **ุงูุณุนุฑ ุงููุฏููุน ูุนููุงู ูู Stripe**: ุงููุจูุบ ุงูุญูููู ุงูุฐู ุชู ุฏูุนู
- **ุงูุณุนุฑ ูู ุฑุณุงุฆู ุงูุชุฃููุฏ**: ูุฃุฎูุฐ ูู `booking.totalGBP` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

## ๐๏ธ ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ

### 1. โ ุชุญุฏูุซ Stripe Webhook
**ุงูููู**: `apps/web/src/app/api/webhooks/stripe/route.ts`

```typescript
// ุงูุญุตูู ุนูู ุงููุจูุบ ุงููุนูู ุงููุฏููุน ูู ุฌูุณุฉ Stripe
const actualPaidAmount = session.amount_total ? session.amount_total / 100 : (booking.totalGBP ? booking.totalGBP / 100 : 0);

// ุงุณุชุฎุฏุงู ุงููุจูุบ ุงููุนูู ูู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุงูุฑุณุงุฆู ุงููุตูุฉ
const emailData = {
  // ... ุจุงูู ุงูุจูุงูุงุช
  totalPrice: actualPaidAmount, // โ ุงููุจูุบ ุงููุนูู ุงููุฏููุน
};

const smsData = {
  // ... ุจุงูู ุงูุจูุงูุงุช  
  totalPrice: actualPaidAmount, // โ ุงููุจูุบ ุงููุนูู ุงููุฏููุน
};
```

### 2. โ ุชุญุฏูุซ ุตูุญุฉ ุงููุฌุงุญ
**ุงูููู**: `apps/web/src/app/booking-luxury/success/page.tsx`

> ููุงุญุธุฉ: ุงููุณุงุฑ ุงููุฏูู `apps/web/src/app/booking/success/page.tsx` ูู ูุนุฏ ูุณุชุฎุฏูุงู ูุชู ุงุณุชุจุฏุงูู ุจ`booking-luxury`. ุฅุฐุง ูุงูุช ููุงู ุฑูุงุจุท ุฎุงุฑุฌูุฉ ุชุนุชูุฏ ุนูู ุงููุณุงุฑ ุงููุฏููุ ูููุตุญ ุจุฅุถุงูุฉ ุฅุนุงุฏุฉ ุชูุฌูู ุฃู ุชูุซูู ุงูุชุบููุฑ.

```typescript
// ุฌูุจ ุงูุจูุงูุงุช ุงูุญููููุฉ ูู ุฌูุณุฉ Stripe
const response = await fetch(`/api/stripe/session/${sessionId}`);
const stripeSession = await response.json();

const realSessionData = {
  // ... ุจุงูู ุงูุจูุงูุงุช
  totalAmount: stripeSession.amount_total ? stripeSession.amount_total / 100 : 0, // โ ุชุญููู ูู pence ุฅูู pounds
};
```

### 3. โ ุชุญุณูู ุงูุณุฌูุงุช (Logging)

ุฅุถุงูุฉ ุณุฌูุงุช ููุตูุฉ ูููุงุฑูุฉ ุงูุฃุณุนุงุฑ:

```typescript
console.log('๐ฐ [WEBHOOK DEBUG] Payment amounts comparison:');
console.log('๐ฐ [WEBHOOK DEBUG] Stripe session amount_total:', session.amount_total, 'pence');
console.log('๐ฐ [WEBHOOK DEBUG] Booking totalGBP:', booking.totalGBP, 'pence');
console.log('๐ฐ [WEBHOOK DEBUG] Using actual paid amount:', actualPaidAmount, 'GBP');
```

### 4. โ ุชุญุฏูุซ Audit Log

ุฅุถุงูุฉ ุชุณุฌูู ุงููุจุงูุบ ุงููุฎุชููุฉ ูู audit log:

```typescript
details: {
  // ... ุจุงูู ุงูุชูุงุตูู
  actualPaidAmount: actualPaidAmount,
  stripePaidAmountPence: session.amount_total,
  bookingAmountPence: booking.totalGBP,
}
```

## ๐ ุงูุชุฏูู ุงูููุญุฏุซ

```
ุงูุนููู ูุฏูุน ุนุจุฑ Stripe
    โ
Stripe Webhook ูุชู ุชุดุบููู
    โ
ุงุณุชุฎุฑุงุฌ ุงููุจูุบ ุงููุนูู ูู session.amount_total
    โ
ุฅุฑุณุงู ุฑุณุงุฆู ุงูุชุฃููุฏ ุจุงููุจูุบ ุงููุนูู ุงููุฏููุน โ
    โ
ุนุฑุถ ุตูุญุฉ ุงููุฌุงุญ ุจุงููุจูุบ ุงููุนูู โ
```

## ๐ฏ ุงููุชุงุฆุฌ

โ **ุฑุณุงุฆู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู**: ุชุนุฑุถ ุงููุจูุบ ุงููุนูู ุงููุฏููุน  
โ **ุงูุฑุณุงุฆู ุงููุตูุฉ**: ุชุนุฑุถ ุงููุจูุบ ุงููุนูู ุงููุฏููุน  
โ **ุตูุญุฉ ุงููุฌุงุญ**: ุชุนุฑุถ ุงููุจูุบ ุงููุนูู ุงููุฏููุน  
โ **ุงูุณุฌูุงุช**: ุชุญุชูู ุนูู ููุงุฑูุฉ ูุงุถุญุฉ ุจูู ุงููุจุงูุบ  
โ **Audit Log**: ูุญุชูู ุนูู ุฌููุน ุงููุจุงูุบ ูููุฑุงุฌุนุฉ  

## ๐ ุงูุฃูุงู ูุงูุงุนุชูุงุฏูุฉ

- **ูุตุฏุฑ ุงูุจูุงูุงุช**: Stripe Session (ูุตุฏุฑ ููุซูู)
- **ุงูุชุญููู**: ูู pence ุฅูู pounds ุจุดูู ุตุญูุญ
- **Fallback**: ูู ุญุงูุฉ ุนุฏู ุชููุฑ ุจูุงูุงุช Stripeุ ุงุณุชุฎุฏุงู ุจูุงูุงุช ุงูุญุฌุฒ
- **ุงูุชุญูู**: ุณุฌูุงุช ููุตูุฉ ูุชุชุจุน ุงููุจุงูุบ

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุฌูุณุฉ Stripe ูู ุงููุตุฏุฑ ุงูุฃุณุงุณู** ูููุจูุบ ุงููุฏููุน
2. **ุจูุงูุงุช ุงูุญุฌุฒ ุชูุณุชุฎุฏู ูู fallback** ููุท
3. **ุงูุชุญููู ูู pence ุฅูู pounds** ูุชู ุจูุณูุฉ ุนูู 100
4. **ุงูุฅุดุนุงุฑุงุช ุงูุชููุงุฆูุฉ** ุชุนูู ุนุจุฑ Webhook ุจุฏูุงู ูู ุงูุตูุญุฉ
