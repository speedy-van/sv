# Render Configuration for Speedy Van
# Production-ready deployment configuration
# https://render.com/docs/blueprint-spec

services:
  # Main Web Application (Next.js)
  - type: web
    name: speedy-van-web
    runtime: node
    plan: standard # Recommended for production
    region: frankfurt # EU Central
    rootDir: apps/web
    buildCommand: |
      cd ../.. && 
      npm install -g pnpm@10.17.0 && 
      pnpm install --frozen-lockfile && 
      NODE_OPTIONS=--max-old-space-size=4096 pnpm --filter ./apps/web build &&
      echo "ðŸ“¦ Copying static files for standalone mode..." &&
      mkdir -p apps/web/.next/standalone/apps/web/.next &&
      cp -r apps/web/.next/static apps/web/.next/standalone/apps/web/.next/static &&
      mkdir -p apps/web/.next/standalone/apps/web &&
      cp -r apps/web/public apps/web/.next/standalone/apps/web/public &&
      echo "âœ… Static files copied successfully!" &&
      ls -la apps/web/.next/standalone/apps/web/
    startCommand: cd .next/standalone/apps/web && node server.js
    healthCheckPath: /api/health
    numInstances: 2 # High availability
    buildFilter:
      paths:
        - apps/web/**
        - packages/**
    # Enable build cache for faster deployments
    autoDeploy: true
    envVars:
      # Node Environment
      - key: NODE_ENV
        value: production
      # Increase Node.js heap memory for build
      - key: NODE_OPTIONS
        value: --max-old-space-size=4096
      
      # Database
      - key: DATABASE_URL
        sync: false # Set in Render Dashboard
      
      # NextAuth
      - key: NEXTAUTH_SECRET
        generateValue: true
      - key: NEXTAUTH_URL
        value: https://speedy-van-web.onrender.com # Update with your domain
      
      # Pusher (Real-time)
      - key: PUSHER_APP_ID
        sync: false
      - key: PUSHER_KEY
        sync: false
      - key: PUSHER_SECRET
        sync: false
      - key: PUSHER_CLUSTER
        value: eu
      - key: NEXT_PUBLIC_PUSHER_KEY
        sync: false
      - key: NEXT_PUBLIC_PUSHER_CLUSTER
        value: eu
      
      # Stripe
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      
      # Email
      - key: RESEND_API_KEY
        sync: false
      - key: MAIL_FROM
        value: noreply@speedy-van.co.uk
      
      # SMS
      - key: THESMSWORKS_KEY
        sync: false
      - key: THESMSWORKS_SECRET
        sync: false
      - key: THESMSWORKS_JWT
        sync: false
      
      # Other
      - key: JWT_SECRET
        generateValue: true
      - key: CUSTOM_KEY
        sync: false
      - key: NEXT_PUBLIC_MAPBOX_TOKEN
        sync: false
      - key: NEXT_PUBLIC_WEATHER_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      
      # Company Info
      - key: NEXT_PUBLIC_COMPANY_NAME
        value: Speedy Van
      - key: NEXT_PUBLIC_COMPANY_PHONE
        value: +44 1202129746
      - key: NEXT_PUBLIC_COMPANY_EMAIL
        value: support@speedy-van.co.uk
      
      # Cron Security (not needed for node-cron, but keep for manual endpoint)
      - key: CRON_SECRET
        generateValue: true

  # Optional: Background Worker (if you want separate process for cron)
  # - type: worker
  #   name: speedy-van-worker
  #   runtime: node
  #   buildCommand: pnpm install
  #   startCommand: node apps/web/src/lib/cron/worker.js
  #   envVars:
  #     - fromService:
  #         type: web
  #         name: speedy-van-web
  #         envVarKey: DATABASE_URL

# Optional: Postgres Database (if not using Neon)
# databases:
#   - name: speedyvan-db
#     databaseName: speedyvan
#     plan: starter # or free
#     region: frankfurt
