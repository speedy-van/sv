# Admin Routing API Endpoints
## API Documentation for Dual Routing System

---

## üìç Base URL
```
Production: https://speedy-van.co.uk/api/admin/routing
Development: http://localhost:3000/api/admin/routing
```

---

## üîê Authentication
All endpoints require admin authentication via NextAuth session cookie.

```
Cookie: next-auth.session-token=YOUR_SESSION_TOKEN
```

---

## üìö API Endpoints

### 1. GET `/settings`
Get current routing configuration

**Request:**
```http
GET /api/admin/routing/settings
Cookie: next-auth.session-token=xxx
```

**Response:**
```json
{
  "success": true,
  "data": {
    "routingMode": "manual",
    "autoRoutingEnabled": false,
    "autoRoutingIntervalMin": 15,
    "maxDropsPerRoute": 10,
    "maxRouteDistanceKm": 50,
    "autoAssignDrivers": false,
    "requireAdminApproval": true,
    "minDropsForAutoRoute": 2
  }
}
```

---

### 2. POST `/settings`
Update routing configuration

**Request:**
```http
POST /api/admin/routing/settings
Content-Type: application/json

{
  "maxDropsPerRoute": 15,
  "maxRouteDistanceKm": 75,
  "autoAssignDrivers": true
}
```

**Response:**
```json
{
  "success": true,
  "message": "Routing configuration updated successfully",
  "data": { /* updated config */ }
}
```

---

### 3. PATCH `/settings/mode`
Toggle routing mode (Auto/Manual)

**Request:**
```http
PATCH /api/admin/routing/settings/mode
Content-Type: application/json

{
  "mode": "auto"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Routing mode switched to AUTO successfully",
  "data": {
    "newMode": "auto",
    "timestamp": "2025-10-11T12:34:56.789Z"
  }
}
```

---

### 4. POST `/trigger`
Manually trigger auto-routing

**Request:**
```http
POST /api/admin/routing/trigger
Cookie: next-auth.session-token=xxx
```

**Response:**
```json
{
  "success": true,
  "data": {
    "routesCreated": 3,
    "bookingsProcessed": 12,
    "dropsCreated": 12,
    "routesAwaitingApproval": 3,
    "errors": [],
    "duration": 4567,
    "timestamp": "2025-10-11T12:34:56.789Z"
  },
  "message": "Successfully created 3 routes from 12 bookings"
}
```

---

### 5. POST `/manual`
Create route manually from selected bookings

**Request:**
```http
POST /api/admin/routing/manual
Content-Type: application/json

{
  "bookingIds": ["booking_1", "booking_2", "booking_3"],
  "driverId": "driver_123",
  "vehicleId": "vehicle_456",
  "startTime": "2025-10-12T09:00:00Z",
  "serviceTier": "standard",
  "skipApproval": false
}
```

**Response:**
```json
{
  "success": true,
  "message": "Route created successfully with 3 stops",
  "data": {
    "routeId": "route_xxx",
    "approvalId": "approval_yyy",
    "requiresApproval": true
  }
}
```

---

### 6. PUT `/manual/preview`
Preview route before creation

**Request:**
```http
PUT /api/admin/routing/manual/preview
Content-Type: application/json

{
  "bookingIds": ["booking_1", "booking_2"]
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "estimatedDuration": 180,
    "estimatedDistance": 45.5,
    "totalDrops": 4,
    "totalValue": 12000,
    "stops": [
      {
        "sequence": 1,
        "address": "123 Main St, Glasgow",
        "lat": 55.8642,
        "lng": -4.2518,
        "type": "pickup",
        "estimatedTime": "2025-10-12T09:00:00Z"
      }
    ],
    "warnings": []
  }
}
```

---

### 7. GET `/approve`
Get pending route approvals

**Request:**
```http
GET /api/admin/routing/approve
Cookie: next-auth.session-token=xxx
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "approval_xxx",
      "routeId": "route_yyy",
      "status": "pending",
      "submittedBy": "system",
      "submittedAt": "2025-10-11T12:00:00Z",
      "autoGenerated": true,
      "totalDrops": 5,
      "totalValue": 15000,
      "estimatedDuration": 240,
      "estimatedDistance": 60.5
    }
  ],
  "count": 1
}
```

---

### 8. POST `/approve`
Approve route and dispatch to driver

**Request:**
```http
POST /api/admin/routing/approve
Content-Type: application/json

{
  "routeId": "route_xxx",
  "driverId": "driver_123"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Route approved successfully"
}
```

**Side Effects:**
- Route status ‚Üí `assigned`
- Driver notified via Pusher + SMS + Push + Email
- Audit log created
- Approval record updated

---

### 9. DELETE `/approve`
Reject route with reason

**Request:**
```http
DELETE /api/admin/routing/approve
Content-Type: application/json

{
  "routeId": "route_xxx",
  "reason": "Route too long for single driver"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Route rejected and released"
}
```

**Side Effects:**
- Route status ‚Üí `cancelled`
- Bookings released (routeId ‚Üí null)
- Drops released (routeId ‚Üí null, status ‚Üí pending)
- Audit log created

---

### 10. GET `/cron`
Check cron job status

**Request:**
```http
GET /api/admin/routing/cron
```

**Response:**
```json
{
  "success": true,
  "data": {
    "enabled": true,
    "intervalMinutes": 15,
    "lastRun": "2025-10-11T12:00:00Z",
    "nextRun": "2025-10-11T12:15:00Z",
    "recentRuns": [
      {
        "timestamp": "2025-10-11T12:00:00Z",
        "result": "success",
        "details": {
          "routesCreated": 2,
          "bookingsProcessed": 8
        }
      }
    ]
  }
}
```

---

### 11. POST `/cron`
Execute auto-routing (called by cron service)

**Request:**
```http
POST /api/admin/routing/cron
Authorization: Bearer YOUR_CRON_SECRET
```

**Response:**
```json
{
  "success": true,
  "data": {
    "routesCreated": 3,
    "bookingsProcessed": 15,
    "dropsCreated": 15,
    "routesAwaitingApproval": 3,
    "errors": [],
    "duration": 5678,
    "timestamp": "2025-10-11T12:00:00Z"
  }
}
```

**‚ö†Ô∏è Security:** This endpoint requires Bearer token matching `CRON_SECRET` env variable.

---

## üîÑ Common Workflows

### Workflow 1: Enable Auto-Routing

```javascript
// 1. Switch to auto mode
await fetch('/api/admin/routing/settings/mode', {
  method: 'PATCH',
  body: JSON.stringify({ mode: 'auto' })
});

// 2. Optionally trigger immediately
await fetch('/api/admin/routing/trigger', {
  method: 'POST'
});

// 3. Monitor results
const result = await fetch('/api/admin/routing/cron');
```

---

### Workflow 2: Create and Approve Route

```javascript
// 1. Preview first
const preview = await fetch('/api/admin/routing/manual/preview', {
  method: 'PUT',
  body: JSON.stringify({ bookingIds: ['id1', 'id2'] })
});

// 2. Create route
const createResult = await fetch('/api/admin/routing/manual', {
  method: 'POST',
  body: JSON.stringify({
    bookingIds: ['id1', 'id2'],
    startTime: new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString()
  })
});

// 3. Approve route
const { routeId } = createResult.data;
await fetch('/api/admin/routing/approve', {
  method: 'POST',
  body: JSON.stringify({
    routeId,
    driverId: 'driver_xxx'
  })
});
```

---

## üêõ Error Responses

### 401 Unauthorized
```json
{
  "error": "Unauthorized"
}
```
**Cause:** Not logged in or not admin role

---

### 400 Bad Request
```json
{
  "error": "Invalid mode. Must be \"auto\" or \"manual\""
}
```
**Cause:** Invalid input parameters

---

### 500 Internal Server Error
```json
{
  "success": false,
  "error": "Failed to create route",
  "details": "No valid drops available for routing"
}
```
**Cause:** Server-side error (check logs)

---

## üìä Rate Limits

**Cron Endpoint:**
- Max 1 request per minute
- Protected by Bearer token

**Admin Endpoints:**
- Max 100 requests per minute per admin
- Burst: 20 requests per second

**Trigger Endpoint:**
- Max 4 requests per minute (prevent spam)

---

## üéâ ÿßŸÑÿÆŸÑÿßÿµÿ©

**11 API endpoints ÿ™ÿ∫ÿ∑Ÿä:**
- ‚úÖ Configuration management
- ‚úÖ Auto/Manual mode switching
- ‚úÖ Route creation and preview
- ‚úÖ Approval workflow
- ‚úÖ Cron job execution
- ‚úÖ Full CRUD operations

**All endpoints are:**
- Type-safe
- Authenticated
- Audited
- Production-ready

**Happy coding! üöÄ**

