# دليل المستخدم - لوحة موافقات الإدارة

**التاريخ:** 4 أكتوبر 2025  
**الإصدار:** 1.0  
**الجمهور:** مديرو Speedy Van

---

## 📖 نظرة عامة

لوحة موافقات الإدارة هي نظام متكامل لمراجعة وموافقة على:
1. **مدفوعات السائقين** التي تجاوزت الحد اليومي (£500)
2. **طلبات المكافآت** من السائقين
3. **سجل التدقيق** لجميع قرارات الإدارة

---

## 🚀 الوصول إلى النظام

### متطلبات الدخول:
- ✅ حساب إداري نشط
- ✅ دور المستخدم: `admin`
- ✅ تسجيل دخول عبر `/auth/login`

### الصفحات المتاحة:
1. **الموافقات المعلقة**: `/admin/approvals`
2. **طلبات المكافآت**: `/admin/bonuses`
3. **سجل التدقيق**: `/admin/audit-trail`

---

## 1️⃣ صفحة الموافقات المعلقة

### الغرض:
مراجعة وموافقة على مدفوعات السائقين التي تجاوزت الحد اليومي £500.

### متى تظهر الموافقات؟
عندما يكمل السائق وظيفة وإجمالي أرباحه اليومية يتجاوز £500، يُرسل طلب موافقة تلقائياً.

### كيفية الاستخدام:

#### أ. عرض الإحصائيات
في أعلى الصفحة، ستجد 3 بطاقات:
- **طلبات معلقة**: عدد المدفوعات التي تحتاج موافقتك
- **متوسط وقت الانتظار**: كم دقيقة مرت منذ إكمال الوظيفة
- **إجمالي المبالغ المعلقة**: مجموع المبالغ المنتظرة

#### ب. مراجعة البطاقات
كل بطاقة تعرض:
- **اسم السائق** والبريد الإلكتروني
- **رقم الحجز** (مثل: SV-2025-001)
- **وقت الانتظار** بالدقائق
- **معلومات الحد**:
  - الحد اليومي: £500.00
  - الإجمالي الحالي: (أرباح السائق حتى الآن)
  - المتبقي: (ما يمكن صرفه دون موافقة)

#### ج. عرض التفاصيل الكاملة
اضغط على أيقونة السهم ↓ لرؤية:
- نوع الخدمة (economy, express, same-day)
- المسافة بالأميال
- عنوان الاستلام
- عنوان التسليم
- وقت إكمال الوظيفة

#### د. الموافقة على الدفع

1. اضغط على زر **"الموافقة"** (أخضر)
2. ستفتح نافذة تحتوي على:
   - **المبلغ المعتمد**: يمكنك تعديله (الحد الأقصى: المتبقي)
   - **ملاحظات الإدارة**: (اختياري) أضف سبب الموافقة
3. اضغر **"تأكيد الموافقة"**

**النتيجة:**
- ✅ يتم إنشاء سجل أرباح للسائق
- ✅ يصل إشعار للسائق: "تم تأكيد دفعتك! 💰 £X"
- ✅ يُسجل في سجل التدقيق
- ✅ تُحذف البطاقة من القائمة

#### هـ. رفض الدفع

1. اضغط على زر **"الرفض"** (أحمر)
2. ستفتح نافذة تحتوي على:
   - **ملاحظات الإدارة**: (مهم!) اشرح سبب الرفض
3. اضغط **"تأكيد الرفض"**

**النتيجة:**
- ❌ لا يتم إنشاء سجل أرباح
- ❌ يصل إشعار للسائق بالرفض + الملاحظات
- ✅ يُسجل في سجل التدقيق
- ✅ تُحذف البطاقة من القائمة

#### و. الإشعارات الفورية
عندما يكمل سائق وظيفة جديدة تتجاوز الحد، ستظهر رسالة تلقائية:
```
🔔 طلب موافقة جديد
السائق [معرف السائق] يحتاج لموافقة إدارية
```

---

## 2️⃣ صفحة طلبات المكافآت

### الغرض:
مراجعة وموافقة على طلبات المكافآت من السائقين أو النظام.

### أنواع المكافآت:
1. **خدمة استثنائية** (Exceptional Service) - لون أخضر
2. **مكافأة إدارية** (Manual Admin Bonus) - لون أزرق
3. **مكافأة إحالة** (Referral Bonus) - لون بنفسجي
4. **مكافأة إنجاز** (Milestone Bonus) - لون برتقالي

### كيفية الاستخدام:

#### أ. عرض الإحصائيات
في أعلى الصفحة:
- **طلبات معلقة**: عدد المكافآت المنتظرة
- **إجمالي المكافآت المعلقة**: مجموع المبالغ
- **متوسط طلب المكافأة**: متوسط المبلغ لكل طلب

#### ب. مراجعة أداء السائق
كل بطاقة تعرض أداء السائق خلال 30 يوم:
- **الوظائف المكتملة**: عدد المهام المنجزة
- **إجمالي الأرباح**: مجموع أرباحه
- **متوسط الأرباح**: معدل الربح لكل وظيفة

#### ج. عرض تفاصيل الطلب
اضغط على السهم ↓ لرؤية:
- **سبب طلب المكافأة**: (مثل: "خدمة ممتازة - تقييم 5 نجوم")
- **تاريخ الطلب**: متى تم تقديم الطلب
- **مقدم الطلب**: النظام التلقائي أو معرف المدير

#### د. الموافقة على المكافأة

1. اضغط على **"الموافقة"** (أخضر)
2. في النافذة:
   - **المبلغ المعتمد**: يمكنك تعديله (الحد الأقصى: المبلغ المطلوب)
   - **ملاحظات الإدارة**: (اختياري) أضف ملاحظات
3. اضغط **"تأكيد الموافقة"**

**النتيجة:**
- ✅ يتم تحديث حالة طلب المكافأة → "معتمد"
- ✅ السائق يمكنه استخدام المكافأة في الوظيفة التالية
- ✅ يصل إشعار: "تمت الموافقة على مكافأتك! 💰 £X"
- ✅ يُسجل في سجل التدقيق

#### هـ. رفض المكافأة

1. اضغط على **"الرفض"** (أحمر)
2. في النافذة:
   - **ملاحظات الإدارة**: (يُنصح) اشرح سبب الرفض
3. اضغط **"تأكيد الرفض"**

**النتيجة:**
- ❌ يتم تحديث حالة الطلب → "مرفوض"
- ❌ يصل إشعار للسائق بالرفض
- ✅ يُسجل في سجل التدقيق

#### و. إنشاء مكافأة يدوياً

1. اضغط على زر **"إنشاء مكافأة"** (أزرق، أعلى الصفحة)
2. في النافذة، أدخل:
   - **معرف السائق** (Driver ID)
   - **معرف المهمة** (Assignment ID)
   - **نوع المكافأة**: اختر من القائمة
   - **المبلغ**: بالجنيه الإسترليني
   - **السبب**: اشرح لماذا تمنح هذه المكافأة
   - **☑️ موافقة تلقائية**: ✔️ = اعتماد فوري، ☐ = يحتاج موافقة لاحقاً
3. اضغط **"إنشاء المكافأة"**

**متى تستخدم "موافقة تلقائية"؟**
- ✅ لمكافآت الإدارة الموثوقة
- ✅ لإنجازات واضحة (100 وظيفة مكتملة)
- ❌ للطلبات التي تحتاج مراجعة إضافية

---

## 3️⃣ صفحة سجل التدقيق

### الغرض:
عرض تاريخ كامل لجميع قرارات الإدارة (موافقات، رفض، تعديلات).

### كيفية الاستخدام:

#### أ. الفلترة المتقدمة
في أعلى الصفحة، 5 فلاتر:

1. **نوع السجل**:
   - الكل
   - تجاوز الحد اليومي
   - موافقة مكافأة
   - تجاوز يدوي

2. **الإجراء**:
   - الكل
   - موافق
   - مرفوض

3. **من تاريخ**: اختر تاريخ البداية

4. **إلى تاريخ**: اختر تاريخ النهاية

5. **بحث**: ابحث عن:
   - معرف الكيان (Entity ID)
   - اسم المدير
   - الملاحظات

**مثال:** لرؤية جميع موافقات المكافآت في سبتمبر:
- نوع السجل: موافقة مكافأة
- الإجراء: موافق
- من تاريخ: 2025-09-01
- إلى تاريخ: 2025-09-30
- اضغط **"بحث"**

#### ب. عرض الإحصائيات
3 بطاقات:
- **إجمالي السجلات**: عدد جميع الإجراءات
- **موافقات**: (باللون الأخضر)
- **رفض**: (باللون الأحمر)

#### ج. مراجعة السجلات
كل بطاقة تعرض:
- **نوع السجل**: (badge ملون)
- **الإجراء**: موافق/مرفوض
- **المسؤول**: من اتخذ القرار
- **نوع الكيان**: driver_earnings أو bonus_request
- **معرف الكيان**: رقم فريد
- **التاريخ والوقت**: متى حدث

#### د. عرض التغييرات
اضغط على السهم ↓ لرؤية:
- **السبب**: لماذا تم اتخاذ القرار
- **الملاحظات**: أي ملاحظات إضافية
- **القيمة السابقة**: حالة البيانات قبل القرار (JSON)
- **القيمة الجديدة**: حالة البيانات بعد القرار (JSON)

#### هـ. عرض التفاصيل الكاملة
اضغط على **"عرض التفاصيل الكاملة"** لفتح نافذة تعرض:
- جدول كامل بجميع المعلومات
- JSON منسق للقيمة السابقة
- JSON منسق للقيمة الجديدة

**استخدامات سجل التدقيق:**
- 🔍 **التدقيق**: من وافق على ماذا ومتى
- 📊 **التقارير**: عدد الموافقات/الرفض شهرياً
- 🛡️ **الامتثال**: إثبات أن جميع القرارات موثقة
- 🐛 **استكشاف الأخطاء**: تتبع تغيير معين

---

## ⚡ الإشعارات الفورية

### كيف تعمل؟
النظام يستخدم تقنية **Pusher** للتحديثات الفورية. لا تحتاج لتحديث الصفحة!

### الإشعارات المدعومة:

#### في صفحة الموافقات المعلقة:
```
🔔 طلب موافقة جديد
السائق [معرف] يحتاج لموافقة إدارية
```
- **متى؟** عندما يكمل سائق وظيفة تتجاوز £500
- **الإجراء:** القائمة تُحدث تلقائياً، البطاقة الجديدة تظهر

#### في صفحة طلبات المكافآت:
```
🔔 طلب مكافأة جديد
طلب مكافأة من السائق [معرف]
```
- **متى؟** عندما يُقدم طلب مكافأة جديد
- **الإجراء:** القائمة تُحدث تلقائياً

### إذا لم تعمل الإشعارات؟
1. تحقق من اتصال الإنترنت
2. افتح Console المتصفح (F12) وابحث عن رسائل Pusher
3. تأكد من أن `NEXT_PUBLIC_PUSHER_KEY` مُعرف

---

## 🎯 أفضل الممارسات

### عند الموافقة على المدفوعات:
1. ✅ راجع **أداء السائق** اليومي
2. ✅ تحقق من **سبب تجاوز الحد** (هل كانت وظائف استثنائية؟)
3. ✅ إذا كان التجاوز بسيطاً (£10-20)، وافق بسرعة
4. ✅ إذا كان التجاوز كبيراً (£100+)، راجع بدقة
5. ✅ أضف ملاحظات واضحة لسجل التدقيق

### عند الموافقة على المكافآت:
1. ✅ راجع **أداء السائق 30 يوم**:
   - إذا كان يكمل < 10 وظائف/شهر → راجع بحذر
   - إذا كان يكمل > 50 وظيفة/شهر → أداء جيد
2. ✅ تحقق من **سبب الطلب**:
   - "خدمة ممتازة" → ابحث عن دليل (تقييم العميل)
   - "إنجاز 100 وظيفة" → تحقق من الرقم
3. ✅ إذا كان المبلغ معقول (£10-50)، وافق
4. ✅ إذا كان المبلغ كبير (£100+)، راجع التفاصيل

### عند الرفض:
1. ⚠️ **اشرح السبب دائماً** في ملاحظات الإدارة
2. ⚠️ كن واضحاً ومهنياً
3. ⚠️ أمثلة جيدة:
   - ✅ "الأرباح اليومية تتجاوز السياسة بشكل كبير"
   - ✅ "لم يتم تأكيد خدمة استثنائية من العميل"
   - ✅ "طلب مكرر - تم الموافقة سابقاً"
4. ❌ أمثلة سيئة:
   - ❌ "لا" (غير واضح)
   - ❌ "سبب غير معروف" (غير مفيد)

### إدارة الوقت:
- ⏰ راجع الموافقات المعلقة **كل ساعتين** خلال ساعات الذروة
- ⏰ أولوية للمدفوعات التي تنتظر > 30 دقيقة
- ⏰ طلبات المكافآت يمكن مراجعتها يومياً

---

## 🆘 استكشاف الأخطاء

### المشكلة: لا تظهر أي موافقات معلقة
**السبب المحتمل:**
- ✅ لا يوجد سائقون تجاوزوا الحد اليوم
- ✅ تم معالجة جميع الطلبات

**الحل:**
- انتقل إلى `/admin/audit-trail` لرؤية آخر الموافقات

### المشكلة: زر "الموافقة" لا يعمل
**السبب المحتمل:**
- API endpoint غير متاح
- مشكلة في الاتصال بالإنترنت

**الحل:**
1. افتح Console المتصفح (F12)
2. ابحث عن أخطاء API (رسائل حمراء)
3. تواصل مع الدعم الفني

### المشكلة: الإشعارات الفورية لا تعمل
**السبب المحتمل:**
- Pusher غير متصل
- مفاتيح البيئة غير صحيحة

**الحل:**
1. افتح Console المتصفح
2. ابحث عن "Pusher connection"
3. إذا رأيت "failed" → تواصل مع الدعم الفني

### المشكلة: سجل التدقيق فارغ
**السبب المحتمل:**
- AdminApproval model لم يتم ترحيله بعد
- لا توجد إجراءات إدارية حتى الآن

**الحل:**
- إذا كانت هذه بيئة جديدة، انتظر أول موافقة
- إذا كانت بيئة قديمة، تواصل مع الدعم الفني

---

## 📞 الدعم الفني

### معلومات الاتصال:
- **البريد الإلكتروني:** support@speedy-van.co.uk
- **الهاتف:** +44 XXX XXXX XXXX
- **ساعات العمل:** الإثنين - الجمعة، 9 صباحاً - 6 مساءً

### عند الإبلاغ عن مشكلة، قدم:
1. **لقطة شاشة** للمشكلة
2. **Console logs** (F12 → Console → انسخ الأخطاء)
3. **الخطوات** لإعادة إنتاج المشكلة
4. **المتصفح والإصدار** (مثل: Chrome 118)

---

## 📚 موارد إضافية

### للمديرين الجدد:
1. اقرأ `DRIVER_PRICING_WORKFLOW.md` لفهم القواعد
2. راجع أول 10 سجلات في سجل التدقيق لرؤية أمثلة
3. ابدأ بموافقة بسيطة (تجاوز £10-20 فقط)

### للمديرين المتقدمين:
1. استخدم الفلاتر في سجل التدقيق للتقارير
2. راقب أنماط تجاوز الحد لتحسين السياسات
3. راجع أداء السائقين شهرياً

---

**نهاية الدليل** 📘

**الإصدار:** 1.0  
**آخر تحديث:** 4 أكتوبر 2025  
**إعداد:** فريق تطوير Speedy Van
