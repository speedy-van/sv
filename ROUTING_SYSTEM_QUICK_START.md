# Dual Routing System - Quick Start Guide
## دليل البدء السريع - نظام التوجيه المزدوج

---

## 🎯 ما هو النظام؟

**نظام توجيه ذكي مزدوج يدعم:**
- ⚡ **Auto Mode** - تجميع تلقائي للحجوزات في طرق محسّنة
- 🖐️ **Manual Mode** - إنشاء يدوي للطرق من قبل الأدمن
- ✅ **Approval System** - مراجعة واعتماد الطرق قبل إرسالها للسائقين
- 📊 **Full Audit Trail** - تتبع كامل لجميع العمليات

---

## ⚙️ التثبيت السريع (5 دقائق)

### 1. تشغيل Migration
```bash
cd packages/shared
pnpm run prisma:migrate
```

### 2. إضافة Environment Variables
```bash
# In .env.local
CRON_SECRET=your_secure_secret_here
```

### 3. Initialize Settings
افتح Prisma Studio:
```bash
cd packages/shared
pnpm run prisma:studio
```

اذهب إلى `SystemSettings` → Add Record:
```json
{
  "routingMode": "manual",
  "autoRoutingEnabled": false,
  "autoRoutingIntervalMin": 15,
  "maxDropsPerRoute": 10,
  "maxRouteDistanceKm": 50,
  "autoAssignDrivers": false,
  "requireAdminApproval": true,
  "minDropsForAutoRoute": 2,
  "updatedBy": "system"
}
```

### 4. Deploy
```bash
cd apps/web
pnpm run build
```

✅ **Done! النظام جاهز.**

---

## 🚀 الاستخدام اليومي

### Scenario 1: تفعيل Auto Mode

**From Admin Dashboard:**
1. افتح `/admin/dashboard`
2. ستجد **Routing Mode Toggle** في الأعلى
3. اضغط على Switch → سيتحول إلى **AUTO**
4. النظام الآن يشتغل تلقائياً كل 15 دقيقة

**What happens:**
```
Every 15 minutes:
  → System fetches confirmed bookings (routeId = null)
  → Groups them by proximity + time
  → Creates optimized routes
  → Sends for admin approval (if enabled)
  → Dispatches to drivers (if auto-approved)
```

**Manual Trigger:**
- اضغط على **"Trigger Now"** لتشغيل فوري

---

### Scenario 2: إنشاء Route يدوياً

**From Orders Page:**
1. افتح `/admin/orders`
2. حدد 2+ حجوزات (✅ checkboxes)
3. اضغط **"Create Route"**
4. Route Preview Modal يفتح
5. راجع:
   - عدد التوقفات
   - الوقت المقدر
   - المسافة
   - القيمة الإجمالية
6. اختر سائق (اختياري)
7. اضغط **"Approve & Create"**

**Result:**
- Route تم إنشاؤه
- Bookings مربوطة بـ routeId
- إشعارات للسائق (Pusher + SMS + Push + Email)
- تظهر في `/admin/routes`

---

### Scenario 3: مراجعة واعتماد Routes

**From Routes Page:**
1. افتح `/admin/routes`
2. ستجد routes بحالة **"Pending Approval"**
3. اضغط **"Review"** على أي route
4. Route Preview Modal يفتح
5. راجع التفاصيل
6. اختر:
   - ✅ **Approve** → يتم إرسالها للسائق مباشرة
   - ❌ **Reject** → تحرير الحجوزات + كتابة سبب الرفض

---

### Scenario 4: تعطيل Auto Mode (Emergency)

**If something goes wrong:**
1. افتح `/admin/dashboard`
2. اضغط على Toggle → سيتحول إلى **MANUAL**
3. النظام يتوقف عن التشغيل التلقائي فوراً

**Alternative (API):**
```bash
curl -X PATCH https://speedy-van.co.uk/api/admin/routing/settings/mode \
  -H "Content-Type: application/json" \
  -d '{"mode": "manual"}'
```

---

## 📊 مراقبة النظام

### Real-time Monitoring

**Admin Dashboard:**
- Current mode displayed
- Last run time
- Next scheduled run
- Recent history

**Logs Page:**
```
/admin/logs?type=auto_routing
```

### Database Queries

**Check auto-routing history:**
```sql
SELECT 
  "eventType",
  "details",
  "result",
  "timestamp"
FROM "SystemAuditLog"
WHERE "eventType" IN ('auto_routing_run', 'auto_routing_completed')
ORDER BY "timestamp" DESC
LIMIT 20;
```

**Check pending approvals:**
```sql
SELECT 
  ra.id,
  ra."routeId",
  ra."status",
  ra."totalDrops",
  ra."totalValue",
  ra."submittedAt",
  ra."autoGenerated"
FROM "RouteApproval" ra
WHERE ra."status" = 'pending'
ORDER BY ra."submittedAt" DESC;
```

**Check driver notifications:**
```sql
SELECT 
  "eventType",
  "targetId" as "routeId",
  "details",
  "timestamp"
FROM "SystemAuditLog"
WHERE "eventType" IN ('driver_notified', 'driver_notification_failed')
ORDER BY "timestamp" DESC
LIMIT 20;
```

---

## 🔧 الإعدادات المتقدمة

### تخصيص Auto-Routing Behavior

**Via API:**
```javascript
const response = await fetch('/api/admin/routing/settings', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    maxDropsPerRoute: 15, // زيادة عدد التوقفات
    maxRouteDistanceKm: 75, // زيادة نطاق البحث
    autoAssignDrivers: true, // تفعيل الإسناد التلقائي
    requireAdminApproval: false, // إلغاء المراجعة (خطر!)
    minDropsForAutoRoute: 3, // حد أدنى أعلى
  })
});
```

**⚠️ Warning:**
- `requireAdminApproval: false` = routes تذهب مباشرة للسائقين بدون مراجعة
- استخدم فقط في حالات الطوارئ أو إذا كنت واثقاً 100% من النظام

---

### تخصيص Cron Interval

**Change from 15 to 10 minutes:**
```javascript
await fetch('/api/admin/routing/settings', {
  method: 'POST',
  body: JSON.stringify({
    autoRoutingIntervalMin: 10
  })
});
```

**Update `vercel.json`:**
```json
{
  "crons": [{
    "path": "/api/admin/routing/cron",
    "schedule": "*/10 * * * *"
  }]
}
```

---

## 🐛 استكشاف الأخطاء

### Problem: Auto-routing لا يعمل

**Check:**
```sql
SELECT * FROM "SystemSettings" LIMIT 1;
```

**Verify:**
- `autoRoutingEnabled = true`
- `routingMode = 'auto'`
- `lastAutoRoutingRun` تحدث كل 15 دقيقة

**Solution:**
1. Toggle mode manually from dashboard
2. Click "Trigger Now" to test
3. Check audit log for errors

---

### Problem: Routes لا تظهر في Admin

**Check:**
```sql
SELECT COUNT(*) FROM "Route" WHERE "createdAt" > NOW() - INTERVAL '24 hours';
SELECT COUNT(*) FROM "RouteApproval" WHERE "status" = 'pending';
```

**Solution:**
- Refresh the page
- Check filters (status, date range)
- Verify routes were actually created

---

### Problem: Driver لم يستلم إشعار

**Check notification log:**
```sql
SELECT * FROM "SystemAuditLog"
WHERE "eventType" = 'driver_notification_failed'
ORDER BY "timestamp" DESC
LIMIT 10;
```

**Common Causes:**
- Driver phone number incorrect
- SMS API credentials expired
- Pusher connection issue
- Driver app not installed

**Solution:**
- Verify driver contact info
- Check API keys in .env
- Manually call driver as backup

---

## 📞 API Examples (Copy-Paste Ready)

### 1. Get Current Config
```bash
curl https://speedy-van.co.uk/api/admin/routing/settings \
  -H "Cookie: YOUR_ADMIN_COOKIE"
```

### 2. Switch to Auto Mode
```bash
curl -X PATCH https://speedy-van.co.uk/api/admin/routing/settings/mode \
  -H "Content-Type: application/json" \
  -H "Cookie: YOUR_ADMIN_COOKIE" \
  -d '{"mode": "auto"}'
```

### 3. Trigger Auto-Routing Now
```bash
curl -X POST https://speedy-van.co.uk/api/admin/routing/trigger \
  -H "Cookie: YOUR_ADMIN_COOKIE"
```

### 4. Create Manual Route
```bash
curl -X POST https://speedy-van.co.uk/api/admin/routing/manual \
  -H "Content-Type: application/json" \
  -H "Cookie: YOUR_ADMIN_COOKIE" \
  -d '{
    "bookingIds": ["booking_id_1", "booking_id_2"],
    "driverId": "driver_id",
    "startTime": "2025-10-12T09:00:00Z"
  }'
```

### 5. Approve Route
```bash
curl -X POST https://speedy-van.co.uk/api/admin/routing/approve \
  -H "Content-Type: application/json" \
  -H "Cookie: YOUR_ADMIN_COOKIE" \
  -d '{
    "routeId": "route_xxx",
    "driverId": "driver_xxx"
  }'
```

### 6. Reject Route
```bash
curl -X DELETE https://speedy-van.co.uk/api/admin/routing/approve \
  -H "Content-Type: application/json" \
  -H "Cookie: YOUR_ADMIN_COOKIE" \
  -d '{
    "routeId": "route_xxx",
    "reason": "Route not optimized properly"
  }'
```

---

## 🎓 Best Practices

### 1. Start with Manual Mode
- تعرّف على النظام أولاً
- راقب كيف يتم إنشاء الطرق
- افهم الأنماط

### 2. Test Auto Mode in Staging
- جرّب على بيانات حقيقية قليلة أولاً
- راقب النتائج
- اضبط الإعدادات حسب الحاجة

### 3. Always Use Approval Mode Initially
- `requireAdminApproval: true`
- راجع كل route قبل إرسالها
- اكتسب ثقة في النظام

### 4. Monitor Regularly
- افتح Dashboard يومياً
- راجع audit logs أسبوعياً
- تابع metrics شهرياً

### 5. Gather Feedback
- استمع لملاحظات السائقين
- راقب customer satisfaction
- اضبط الإعدادات باستمرار

---

## 📈 Metrics to Track

**Daily:**
- Routes created (auto vs manual)
- Approval rate (approved vs rejected)
- Average bookings per route
- Driver notification success rate

**Weekly:**
- Route optimization efficiency
- Time saved vs manual creation
- Admin approval time
- Driver feedback scores

**Monthly:**
- Cost savings from optimization
- System uptime
- Error rate
- Performance trends

---

## 🎉 Success Stories (Use Cases)

### Use Case 1: Busy Morning Rush
**Scenario:** 20 bookings between 8-10 AM in Glasgow

**Auto Mode:**
- System groups into 3 optimized routes
- Routes created in < 10 seconds
- Drivers notified immediately
- Admin reviews and approves in 2 minutes
- Total time: **12 minutes**

**Manual Mode (old way):**
- Admin manually reviews 20 bookings
- Manually groups by area
- Creates 3 routes individually
- Assigns drivers one by one
- Total time: **45+ minutes**

**Time Saved: 33 minutes** ⚡

---

### Use Case 2: Late Evening Scattered Orders
**Scenario:** 5 bookings across wide area

**Auto Mode:**
- System creates 2-3 routes based on proximity
- Optimizes for minimal driving distance
- Admin can review and merge if needed

**Benefit:** No manual calculation required

---

### Use Case 3: Emergency Rush Order
**Scenario:** Urgent booking needs immediate assignment

**Manual Mode:**
1. Select urgent booking + nearby bookings
2. Preview route
3. Assign best available driver
4. Skip approval → immediate dispatch

**Total time: < 2 minutes** 🚀

---

## 🔔 Notification Channels Explained

### 1. Pusher (Real-time)
- **When:** Immediately on route assignment
- **Where:** Driver App (if open)
- **Contains:** Route ID, total stops, start time
- **Latency:** < 1 second

### 2. SMS
- **When:** Immediately after Pusher
- **Where:** Driver's phone number
- **Contains:** Summary + app reminder
- **Latency:** 1-3 seconds

### 3. Push Notification (Expo)
- **When:** Immediately after SMS
- **Where:** iOS/Android device (if app installed)
- **Contains:** Route summary + badge count
- **Latency:** 2-5 seconds

### 4. Email (Backup)
- **When:** Last fallback
- **Where:** Driver's email
- **Contains:** Full route details HTML
- **Latency:** 5-10 seconds

**All channels work independently** - if one fails, others still work.

---

## 🎮 Live Demo Scenarios

### Demo 1: Auto-Routing in Action

```bash
# 1. Enable Auto Mode
curl -X PATCH http://localhost:3000/api/admin/routing/settings/mode \
  -H "Content-Type: application/json" \
  -d '{"mode": "auto"}'

# 2. Create test bookings (use booking UI or API)

# 3. Trigger routing manually (don't wait for cron)
curl -X POST http://localhost:3000/api/admin/routing/trigger \
  -H "Cookie: YOUR_ADMIN_COOKIE"

# 4. Check results
curl http://localhost:3000/api/admin/routes
```

---

### Demo 2: Manual Route with Preview

```bash
# 1. Get booking IDs
curl http://localhost:3000/api/admin/orders?status=CONFIRMED

# 2. Preview route
curl -X PUT http://localhost:3000/api/admin/routing/manual/preview \
  -H "Content-Type: application/json" \
  -d '{"bookingIds": ["id1", "id2", "id3"]}'

# 3. Create route
curl -X POST http://localhost:3000/api/admin/routing/manual \
  -H "Content-Type: application/json" \
  -d '{
    "bookingIds": ["id1", "id2", "id3"],
    "startTime": "2025-10-12T09:00:00Z",
    "driverId": "driver_id"
  }'
```

---

### Demo 3: Approval Workflow

```bash
# 1. Get pending approvals
curl http://localhost:3000/api/admin/routing/approve

# 2. Approve a route
curl -X POST http://localhost:3000/api/admin/routing/approve \
  -H "Content-Type: application/json" \
  -d '{
    "routeId": "route_xxx",
    "driverId": "driver_xxx"
  }'

# OR reject it
curl -X DELETE http://localhost:3000/api/admin/routing/approve \
  -H "Content-Type: application/json" \
  -d '{
    "routeId": "route_xxx",
    "reason": "Not optimal for this driver"
  }'
```

---

## 📱 Driver App Integration

**What Driver Sees:**

1. **Real-time Notification (Pusher):**
   ```
   🔔 New Route Assigned
   📦 5 stops starting at 9:00 AM
   Tap to view details
   ```

2. **SMS:**
   ```
   Hi John, you have been assigned a new route 
   with 5 stops starting at 09:00. Please check 
   your app for details. - Speedy Van
   ```

3. **Push Notification:**
   ```
   🚚 New Route Assigned
   5 stops starting at 09:00
   [Badge: 1]
   ```

4. **Email:**
   ```
   Subject: New Route Assigned - 5 Stops
   
   Hi John,
   You have been assigned a new delivery route:
   - Route ID: route_xxx
   - Total Stops: 5
   - Start Time: 12 Oct 2025, 09:00
   - Estimated Duration: 180 minutes
   
   Please open your app to view details.
   ```

**Driver App must:**
- Listen to Pusher channel: `driver-{driverId}`
- Handle event: `new-route-assigned`
- Fetch route details: `GET /api/driver/routes/{routeId}`
- Update UI immediately

---

## ⚡ Pro Tips

### Tip 1: Optimize for Peak Hours
```javascript
// Set tighter clustering during rush hours
{
  "maxRouteDistanceKm": 30, // Smaller radius
  "maxDropsPerRoute": 8, // Fewer stops
}
```

### Tip 2: Weekend Relaxed Mode
```javascript
// Allow larger routes on weekends
{
  "maxRouteDistanceKm": 75,
  "maxDropsPerRoute": 12,
}
```

### Tip 3: Approval Bypass for Trusted Scenarios
```javascript
// Skip approval for small, simple routes
if (totalDrops <= 3 && totalDistance < 20) {
  skipApproval = true;
}
```

### Tip 4: Monitor and Adjust
- Review metrics weekly
- Adjust thresholds based on actual performance
- Listen to driver feedback

---

## 🎯 Key Performance Indicators

**Track these daily:**
- ✅ Auto-routing success rate: > 90%
- ✅ Average route creation time: < 5s
- ✅ Notification delivery rate: > 95%
- ✅ Admin approval time: < 5 min
- ✅ Driver acceptance rate: > 85%

**Red flags:**
- ❌ Many rejected routes (> 20%)
- ❌ Long approval times (> 30 min)
- ❌ Frequent errors in logs
- ❌ Driver complaints about routes

---

## 📞 Need Help?

**Documentation:**
- Full implementation: `DUAL_ROUTING_SYSTEM_IMPLEMENTATION.md`
- Testing guide: `TESTING_GUIDE.md`
- Deployment checklist: `DEPLOYMENT_CHECKLIST.md`

**Support:**
- Email: support@speedy-van.co.uk
- Phone: 07901846297

**Developer Support:**
- Check `SystemAuditLog` for detailed errors
- Review code in `apps/web/src/lib/orchestration/RouteManager.ts`
- Monitor Vercel logs for cron job execution

---

## ✅ Summary

**نظام كامل ومتكامل:**
- ⚡ Auto mode للتجميع التلقائي
- 🖐️ Manual mode للتحكم الكامل
- ✅ Approval system للمراجعة
- 📊 Full audit trail للتتبع
- 🔔 Multi-channel notifications
- 🛡️ Safety rules and validation
- 📈 Performance monitoring

**الحمد لله، النظام جاهز وقوي! 💪**

**Happy Routing! 🚀**

