# โ ุชุญุฏูุซ ูุนุฏูุงุช ุฃุฑุจุงุญ ุงูุณุงุฆููู

## ๐ ุงูุชุงุฑูุฎ: 2025-10-26

---

## ๐ฏ ุงููุฏู ูู ุงูุชุญุฏูุซ

ุฑูุน ุฃุฑุจุงุญ ุงูุณุงุฆููู ุจุดูู ูุนุชุฏู ููุชูุงุฒู ุฏูู ุงูุชุฃุซูุฑ ุณูุจุงู ุนูู ูุงูุด ุฑุจุญ ุงูููุตุฉ.

---

## ๐ ุงูุชุบููุฑุงุช ุงููุทุจูุฉ

### ุงููุนุฏูุงุช ุงููุฏููุฉ:
```typescript
baseFarePerJob: ยฃ25.00        // โ ุจุฏูู ุชุบููุฑ
perDropFee: ยฃ12.00           // โ ุจุฏูู ุชุบููุฑ
perMileFee: ยฃ0.55 per mile   // โ ููุฎูุถ
perMinuteFee: ยฃ0.15 per min  // โ ููุฎูุถ
```

### ุงููุนุฏูุงุช ุงูุฌุฏูุฏุฉ:
```typescript
baseFarePerJob: ยฃ25.00        // โ ุจุฏูู ุชุบููุฑ
perDropFee: ยฃ12.00           // โ ุจุฏูู ุชุบููุฑ
perMileFee: ยฃ0.85 per mile   // โ ุฒูุงุฏุฉ 54%
perMinuteFee: ยฃ0.25 per min  // โ ุฒูุงุฏุฉ 67%
```

---

## ๐ฐ ุชุฃุซูุฑ ุงูุชุบููุฑ (ูุซุงู ุนููู)

### ุทูุจ ูููุฐุฌู:
- ุงููุณุงูุฉ: 15 miles
- ุงูููุช: 45 minutes
- ุนุฏุฏ ุงูููุงุท: 3 drops
- ุงูุญุงูุฉ: on-time delivery
- ุงูุชูููู: 4.8 stars
- ุจุฏูู ูุณุงุนุฏ

### ุงูุญุณุงุจ ุงููุฏูู:
```
baseFare = ยฃ25.00
perDropFee = 3 ร ยฃ12.00 = ยฃ36.00
mileageFee = 15 ร ยฃ0.55 = ยฃ8.25    โ ููุฎูุถ
timeFee = 45 ร ยฃ0.15 = ยฃ6.75       โ ููุฎูุถ

subtotal = (ยฃ25 + ยฃ36 + ยฃ8.25 + ยฃ6.75) ร 1.0 ร 1.05
         = ยฃ76.00 ร 1.05 = ยฃ79.80

bonuses:
  onTimeBonus = ยฃ5.00
  multiDropBonus = ยฃ20.00
  highRatingBonus = ยฃ8.00
  total = ยฃ33.00

grossEarnings = ยฃ79.80 + ยฃ33.00 = ยฃ112.80
netEarnings = ยฃ112.80

ุงููุชูุฌุฉ ุงููุฏููุฉ: ยฃ112.80 (~128 ุฑูุงู)
```

### ุงูุญุณุงุจ ุงูุฌุฏูุฏ:
```
baseFare = ยฃ25.00
perDropFee = 3 ร ยฃ12.00 = ยฃ36.00
mileageFee = 15 ร ยฃ0.85 = ยฃ12.75   โ ุฒูุงุฏุฉ ยฃ4.50
timeFee = 45 ร ยฃ0.25 = ยฃ11.25      โ ุฒูุงุฏุฉ ยฃ4.50

subtotal = (ยฃ25 + ยฃ36 + ยฃ12.75 + ยฃ11.25) ร 1.0 ร 1.05
         = ยฃ85.00 ร 1.05 = ยฃ89.25

bonuses:
  onTimeBonus = ยฃ5.00
  multiDropBonus = ยฃ20.00
  highRatingBonus = ยฃ8.00
  total = ยฃ33.00

grossEarnings = ยฃ89.25 + ยฃ33.00 = ยฃ122.25
netEarnings = ยฃ122.25

ุงููุชูุฌุฉ ุงูุฌุฏูุฏุฉ: ยฃ122.25 (~139 ุฑูุงู)

ุงูุฒูุงุฏุฉ: ยฃ9.45 (~10.7 ุฑูุงู) - ุฒูุงุฏุฉ 8.4%
```

---

## ๐ ุงูุชุฃุซูุฑ ุนูู ุณููุงุฑูููุงุช ูุฎุชููุฉ

### 1. ุฑุญูุฉ ูุตูุฑุฉ (5 miles, 20 min, 1 drop):
```
ูุฏูู: ยฃ25 + ยฃ12 + ยฃ2.75 + ยฃ3 = ยฃ42.75
ุฌุฏูุฏ: ยฃ25 + ยฃ12 + ยฃ4.25 + ยฃ5 = ยฃ46.25
ุฒูุงุฏุฉ: ยฃ3.50 (8.2%)
```

### 2. ุฑุญูุฉ ูุชูุณุทุฉ (10 miles, 35 min, 2 drops):
```
ูุฏูู: ยฃ25 + ยฃ24 + ยฃ5.50 + ยฃ5.25 = ยฃ59.75
ุฌุฏูุฏ: ยฃ25 + ยฃ24 + ยฃ8.50 + ยฃ8.75 = ยฃ66.25
ุฒูุงุฏุฉ: ยฃ6.50 (10.9%)
```

### 3. ุฑุญูุฉ ุทูููุฉ (25 miles, 70 min, 4 drops):
```
ูุฏูู: ยฃ25 + ยฃ48 + ยฃ13.75 + ยฃ10.50 = ยฃ97.25 + bonuses
ุฌุฏูุฏ: ยฃ25 + ยฃ48 + ยฃ21.25 + ยฃ17.50 = ยฃ111.75 + bonuses
ุฒูุงุฏุฉ: ยฃ14.50 (14.9%)
```

### 4. ูุณุงุฑ ูุชุนุฏุฏ ุงูููุงุท (20 miles, 90 min, 5 drops):
```
ูุฏูู: ยฃ25 + ยฃ60 + ยฃ11.00 + ยฃ13.50 = ยฃ109.50 + bonuses
ุฌุฏูุฏ: ยฃ25 + ยฃ60 + ยฃ17.00 + ยฃ22.50 = ยฃ124.50 + bonuses
ุฒูุงุฏุฉ: ยฃ15.00 (13.7%)
```

---

## ๐ฏ ุงูููุงุฆุฏ ุงููุชููุนุฉ

### ููุณุงุฆููู:
- โ ุฒูุงุฏุฉ ุงูุฃุฑุจุงุญ ุจูุณุจุฉ **8-15%** ุญุณุจ ููุน ุงูุฑุญูุฉ
- โ ุชุนููุถ ุฃูุถู ุนู ุงููุณุงูุงุช ุงูุทูููุฉ
- โ ุชุนููุถ ุฃูุถู ุนู ุงูููุช ุงููุณุชุบุฑู
- โ ูุญูุฒ ุงูุณุงุฆููู ุนูู ูุจูู ุฑุญูุงุช ุฃุทูู

### ููููุตุฉ:
- โ ุฒูุงุฏุฉ ูุนุชุฏูุฉ ูุง ุชุคุซุฑ ุณูุจุงู ุนูู ุงูุฃุฑุจุงุญ
- โ ุชุญุณูู ุฑุถุง ุงูุณุงุฆููู
- โ ุชูููู ูุนุฏู ุฑูุถ ุงูุทูุจุงุช
- โ ุงููุญุงูุธุฉ ุนูู ุงูุชูุงุฒู ุงููุงูู

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

### 1. **Driver Earnings Service**
```
apps/web/src/lib/services/driver-earnings-service.ts
```

**ุงูุชุบููุฑุงุช:**
- Line 184: `perMileFee: 85` (ูู 55)
- Line 185: `perMinuteFee: 25` (ูู 15)

### 2. **Database Schema** (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
```
packages/shared/prisma/schema.prisma
```

**PricingSettings model:**
- `perMileFeePence: 85` (default)
- `perMinuteFeePence: 25` (default)

---

## ๐ง ุฎุทูุงุช ุงูุชุทุจูู

### 1. ุชุญุฏูุซ ุงูููุฏ:
```bash
โ ุชู ุชุญุฏูุซ DEFAULT_CONFIG ูู driver-earnings-service.ts
```

### 2. ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุฅุฐุง ูุงูุช ููุงู ุฅุนุฏุงุฏุงุช ูุดุทุฉ):
```sql
UPDATE "PricingSettings" 
SET 
  "perMileFeePence" = 85,
  "perMinuteFeePence" = 25,
  "updatedAt" = NOW()
WHERE "isActive" = true;
```

### 3. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุณูุฑูุฑ:
```bash
pnpm run dev
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### 1. **ุงูุชูุงูู ูุน ุงูุณูู ุงููููู:**
ุงูุณูู ุงููููู ยฃ500 ูุง ูุฒุงู ูุทุจูุงูุ ููู ุงูุณุงุฆู ุณูุตู ุฅููู ุจุนุฏุฏ ุฑุญูุงุช ุฃูู:
- ูุฏูู: ~4.4 ุฑุญูุงุช ูููุตูู ููุณูู
- ุฌุฏูุฏ: ~4.1 ุฑุญูุงุช ูููุตูู ููุณูู

### 2. **ุงูุชุฃุซูุฑ ุนูู Helper Share:**
ูุณุจุฉ ุงููุณุงุนุฏ (20%) ุชุญุณุจ ูู ุงููุจูุบ ุงูุฃุนูู:
- ูุฏูู: 20% ูู ยฃ112.80 = ยฃ22.56
- ุฌุฏูุฏ: 20% ูู ยฃ122.25 = ยฃ24.45

### 3. **ูุง ุชุบููุฑ ูู:**
- โ Base Fare (ยฃ25)
- โ Per Drop Fee (ยฃ12)
- โ Bonuses (on-time, rating, multi-drop)
- โ Penalties
- โ Daily Cap (ยฃ500)
- โ Earnings Floor (ยฃ20)
- โ Helper Share (20%)

---

## ๐ ููุงุฑูุฉ ูุน DriverPricingEngine

### DriverPricingEngine (ุบูุฑ ูุณุชุฎุฏู):
```
Distance: ยฃ1.50/mile
Time: ยฃ0.50/minute
```

### DriverEarningsService ุงูุฌุฏูุฏ:
```
Distance: ยฃ0.85/mile  (56% ูู DriverPricingEngine)
Time: ยฃ0.25/minute    (50% ูู DriverPricingEngine)
```

**ุงูุชุจุฑูุฑ:**
- ุงูุชุนุฏูู ุงูุฌุฏูุฏ ููุงุฒู ุจูู ุงููุนุฏูุงุช ุงูููุฎูุถุฉ (ุงููุฏููุฉ) ูุงููุฑุชูุนุฉ (DriverPricingEngine)
- ูุญุงูุธ ุนูู ุงูุงุณุชุฏุงูุฉ ุงููุงููุฉ ููููุตุฉ
- ูุญุณู ุฃุฑุจุงุญ ุงูุณุงุฆููู ุจุดูู ููุญูุธ ุฏูู ุฅููุงุณ ุงูููุตุฉ

---

## โ ุงุฎุชุจุงุฑ ุงูุชุญุฏูุซ

### Test Case 1: Standard Job
```typescript
const result = await driverEarningsService.calculateEarnings({
  assignmentId: 'test_001',
  driverId: 'driver_001',
  bookingId: 'booking_001',
  distanceMiles: 15,
  durationMinutes: 45,
  dropCount: 3,
  customerPaymentPence: 15000,
  urgencyLevel: 'standard',
  onTimeDelivery: true,
  customerRating: 4.8
});

// Expected: netEarnings โ ยฃ122.25
console.log('Net Earnings:', result.breakdown.netEarnings / 100);
```

### Test Case 2: Long Distance Job
```typescript
const result = await driverEarningsService.calculateEarnings({
  assignmentId: 'test_002',
  driverId: 'driver_001',
  bookingId: 'booking_002',
  distanceMiles: 60,
  durationMinutes: 120,
  dropCount: 2,
  customerPaymentPence: 25000,
  urgencyLevel: 'express',
  onTimeDelivery: true
});

// Expected: Higher earnings due to long distance bonus
console.log('Net Earnings:', result.breakdown.netEarnings / 100);
```

---

## ๐ ุงูุฎูุงุตุฉ

### ุงูุชุบููุฑุงุช ุงููุทุจูุฉ:
- โ ุฒูุงุฏุฉ `perMileFee` ูู ยฃ0.55 ุฅูู ยฃ0.85 (+54%)
- โ ุฒูุงุฏุฉ `perMinuteFee` ูู ยฃ0.15 ุฅูู ยฃ0.25 (+67%)

### ุงููุชุงุฆุฌ ุงููุชููุนุฉ:
- โ ุฒูุงุฏุฉ ุฃุฑุจุงุญ ุงูุณุงุฆููู ุจูุณุจุฉ **8-15%**
- โ ุชุญููุฒ ุฃูุถู ููุฑุญูุงุช ุงูุทูููุฉ
- โ ุชูุงุฒู ูุงูู ูุณุชุฏุงู ููููุตุฉ

### ุงูุญุงูุฉ:
๐ข **ุฌุงูุฒ ูููุดุฑ ูู Production**

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2025-10-26  
**ุงููุณุคูู:** Lead Developer  
**ุงูุญุงูุฉ:** โ ุชู ุงูุชุทุจูู ูุงูุงุฎุชุจุงุฑ

