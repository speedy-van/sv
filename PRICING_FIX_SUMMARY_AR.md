# ๐ด ุฅุตูุงุญ ุญุฑุฌ: ูุธุงู ุงูุชุณุนูุฑ ูุงูุฏูุน - ุนูููุงุช ุงูุฅุฏุงุฑุฉ

## ููุฎุต ุชูููุฐู

ุชู ุฅุตูุงุญ **ุฃุฎุทุงุก ูุญุงุณุจูุฉ ุญุฑุฌุฉ** ูู ูุธุงู ุชูุงุตูู ุงูุทูุจุงุช ุงูุฅุฏุงุฑูุฉ ูุงูุช ุชููุณุฏ ุฅุฌูุงููุงุช ุงูุทูุจุงุช ูุชุณุจุจ ุนุฏู ุชุฒุงูู ูุน ูุธุงู ุงูุฏูุน Stripe.

---

## ๐จ ุงููุดุงูู ุงูุญุฑุฌุฉ ุงูุชู ุชู ุฅุตูุงุญูุง

### 1. **ูุณุงุฏ ูุญุฏุฉ ุงูุนููุฉ** โ ุชู ุงูุฅุตูุงุญ
**ุงููุดููุฉ:** ุงูู API ููุฑุฌุน `amountGbpMinor` ุจุงูุจูุณุ ููู ุงูููุฏ ูุงู ููุณู ุนูู 100 ููุญูุธ ุจุงูุฌูููุงุช ูู ุญูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฐู ูุชููุน ุงูุจูุณ.

**ูุซุงู ุนูู ุงูุฎุทุฃ:**
- ุณุนุฑ ุงูุทูุจ: ยฃ50.00 = 5000 ุจูุณ
- API ููุฑุฌุน: `amountGbpMinor = 5000` (ุจูุณ)
- **ุงูููุฏ ุงููุฏูู:** `5000 / 100 = 50` โ ููุญูุธ ูู `50` ูู `totalGBP`
- **ูุงุนุฏุฉ ุงูุจูุงูุงุช:** `totalGBP` ูู `Int` ูููุฎุฒู **ุงูุจูุณ**
- **ุงูุนุฑุถ:** `50 / 100 = ยฃ0.50` โ **ุฎุทุฃ!**

**ุงูุฅุตูุงุญ:** ุฅุฒุงูุฉ ุงููุณูุฉ ุนูู 100 ุนูุฏ ุงูุญูุธ - ุงูุงุญุชูุงุธ ุจุงููููุฉ ุจุงูุจูุณ

---

### 2. **ุนุฏู ุงูุชุญูู ุนูุฏ ูุดู ุฅุนุงุฏุฉ ุงูุญุณุงุจ** โ ุชู ุงูุฅุตูุงุญ
**ุงููุดููุฉ:** ุงููุธุงู ูุงู ูุณูุญ ุจุญูุธ ุงูุทูุจุงุช ุญุชู ูู ูุดูุช ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุณุนุฑุ ููุง ูุคุฏู ูุฃุณุนุงุฑ ูุฏููุฉ.

**ุงูุฅุตูุงุญ:** ููุน ุนูููุฉ ุงูุญูุธ ุฅุฐุง ุชู ุชุบููุฑ ุชูุงุตูู ุงูุนูุงุฑ ุฃู ุงูุนูุงููู ุจุฏูู ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุณุนุฑุ ูุน ุนุฑุถ ุฑุณุงูุฉ ุชุญุฐูุฑ ูุงุถุญุฉ.

---

### 3. **ุงูุฑููุฒ ุงูุจุฑูุฏูุฉ ุงูุซุงุจุชุฉ** โ ุชู ุงูุฅุตูุงุญ
**ุงููุดููุฉ:** ุงููุธุงู ูุงู ูุณุชุฎุฏู `SW1A 1AA` (ูุตุฑ ุจุงููุฌูุงู) ููููุฉ ุงูุชุฑุงุถูุฉ ููุฑููุฒ ุงูุจุฑูุฏูุฉ ุบูุฑ ุงูุตุงูุญุฉ.

**ุงูุฅุตูุงุญ:** ุฑูุน ุฃุฎุทุงุก ูุงุถุญุฉ ุจุฏูุงู ูู ุงุณุชุฎุฏุงู ููู ุงูุชุฑุงุถูุฉ ุฎุงุทุฆุฉ.

---

### 4. **console.log ูู ุงูุฅูุชุงุฌ** โ ุชู ุงูุฅุตูุงุญ
**ุงููุดููุฉ:** ุงุณุชุฎุฏุงู `console.log` ู `console.error` ุจูุซุฑุฉ ูู ููุฏ ุงูุฅูุชุงุฌ.

**ุงูุฅุตูุงุญ:** ุฅุฒุงูุฉ ุฌููุน console statements ุบูุฑ ุงูุถุฑูุฑูุฉ - ุงูุฃุฎุทุงุก ุงูุขู ุชุธูุฑ ุนุจุฑ toast notifications ูุงุถุญุฉ.

---

### 5. **ุนุฏู ุงูุชุฒุงูู ูุน ุงูุฏูุน** โ ุชู ุงูุฅุตูุงุญ
**ุงููุดููุฉ:** ุงููุณุคูู ูุณุชุทูุน ุชุบููุฑ `totalGBP` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุฏูู ุชุญุฏูุซ Stripe Payment Intentุ ููุง ูุณุจุจ ุนุฏู ุชุทุงุจู ูู ุงูููุชุฑุฉ.

**ุงูุฅุตูุงุญ:**

#### ุชุญุณููุงุช API Endpoint:
- **ูุดู ุชุบููุฑุงุช ุงูุณุนุฑ** ุชููุงุฆูุงู
- **ูุฒุงููุฉ ุชููุงุฆูุฉ ูุน Stripe** ููุทูุจุงุช ุบูุฑ ุงููุฏููุนุฉ
- **ุชุญุฐูุฑ ูููุณุคูู** ููุทูุจุงุช ุงููุฏููุนุฉ (ุชุชุทูุจ ุงุณุชุฑุฏุงุฏ/ุงุฆุชูุงู ูุฏูู)
- **ุชุณุฌูู ุดุงูู** ูู Audit Trail

#### ูุธุงู ุงูุชุญุฐูุฑุงุช:
```typescript
// ุนุฑุถ ุชุญุฐูุฑุงุช ูููุณุคูู
if (result.warning) {
  toast({
    title: 'โ๏ธ ุชุญุฐูุฑ: ูุชุทูุจ ุฅุฌุฑุงุก ูุฏูู',
    description: result.warning.message,
    status: 'warning',
    duration: 10000,
  });
}
```

**ุงูุชุฃุซูุฑ:**
- โ ุทูุจุงุช ุบูุฑ ูุฏููุนุฉ: ูุชู ุชุญุฏูุซ Stripe ุชููุงุฆูุงู
- โ๏ธ ุทูุจุงุช ูุฏููุนุฉ: ุงููุณุคูู ูุญุตู ุนูู ุชุญุฐูุฑ ูุฅุตุฏุงุฑ ุงุณุชุฑุฏุงุฏ/ุงุฆุชูุงู ูุฏููุงู
- ๐ ุฌููุน ุชุบููุฑุงุช ุงูุฃุณุนุงุฑ ููุณุฌูุฉ ูู audit trail

---

## ๐ ุชูุถูุญ Schema ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุญูู `Booking.totalGBP`:
```prisma
model Booking {
  totalGBP Int  // โ ููุฎุฒู ุงููุจูุบ ุจุงูุจูุณ (ููุณ ุจุงูุฌูููุงุช)
}
```

**ุฃูุซูุฉ:**
- ยฃ50.00 โ `totalGBP = 5000` (ุจูุณ)
- ยฃ123.45 โ `totalGBP = 12345` (ุจูุณ)
- ยฃ0.99 โ `totalGBP = 99` (ุจูุณ)

---

## ๐ ุณูุฑ ุงูุนูู ุงูููุญุฏุซ

### ุนูููุฉ ุชุบููุฑ ุงูุณุนุฑ ูู ูุจู ุงููุณุคูู:
1. **ุชุนุฏูู ุงูุทูุจ** โ ุชุบููุฑ ุชูุงุตูู ุงูุนูุงุฑ/ุงูุนูุงููู
2. **ุงูููุฑ ุนูู "Recalculate Price"** โ ุงููุธุงู ูุณุชุฏุนู pricing API
3. **ูุฑุงุฌุนุฉ ุงูุณุนุฑ ุงูุฌุฏูุฏ** โ ุนุฑุถ ููุงุฑูุฉ ุจูู ุงููุฏูู ูุงูุฌุฏูุฏ
4. **ุงูููุฑ ุนูู "Save Changes"** โ ุงููุธุงู ูุชุญูู ููุญุฏุซ
5. **ูุฒุงููุฉ Stripe** โ ุชููุงุฆูุงู ุฅุฐุง ุบูุฑ ูุฏููุนุ ุชุญุฐูุฑ ุฅุฐุง ูุฏููุน
6. **Audit Log** โ ุฌููุน ุงูุชุบููุฑุงุช ููุชุชุจุนุฉ ูุน ุงูููู ูุจู ูุจุนุฏ

---

## ๐ ุชุญุณููุงุช Audit Trail

### ุฅุฌุฑุงุกุงุช Audit ุฌุฏูุฏุฉ:
- `update_order` - ุชุญุฏูุซุงุช ุงูุทูุจ ุงูููุงุณูุฉ ูุน ุชูุงุตูู ุชุบููุฑ ุงูุณุนุฑ
- `stripe_payment_updated` - ูุฒุงููุฉ Stripe ูุงุฌุญุฉ
- `price_change_after_payment` - ุชุญุฐูุฑ ููุณุฌู ููุทูุจุงุช ุงููุฏููุนุฉ
- `stripe_sync_failed` - ุฃุฎุทุงุก Stripe API ููุณุฌูุฉ

---

## โ๏ธ ุงูุฅุฌุฑุงุกุงุช ุงููุฏููุฉ ุงููุทููุจุฉ

### ูุชุบููุฑุงุช ุงูุฃุณุนุงุฑ ุจุนุฏ ุงูุฏูุน:
1. **ูุญุต Audit Log** ููุจุญุซ ุนู `price_change_after_payment`
2. **ุญุณุงุจ ุงููุฑู:**
   - **ุฒูุงุฏุฉ:** ุฅูุดุงุก ูุงุชูุฑุฉ Stripe ูููุจูุบ ุงูุฅุถุงูู
   - **ููุตุงู:** ุฅุตุฏุงุฑ ุงุณุชุฑุฏุงุฏ Stripe ูููุจูุบ ุงูุฒุงุฆุฏ
3. **ุชุญุฏูุซ ุงูุนููู:** ุฅุฑุณุงู ุจุฑูุฏ ุฅููุชุฑููู ูุดุฑุญ ุชุนุฏูู ุงูุณุนุฑ
4. **ูุถุน ุนูุงูุฉ ุชู ุงูุญู:** ุฅุถุงูุฉ ููุงุญุธุฉ ูู audit log

---

## ๐งช ูุงุฆูุฉ ุงููุญุต

### ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ:
- [x] ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุณุนุฑ ููุฎุฒู ุงูุจูุณ (ููุณ ุงูุฌูููุงุช)
- [x] ุงูุฑููุฒ ุงูุจุฑูุฏูุฉ ุบูุฑ ุงูุตุงูุญุฉ ุชุฑูุน ุฃุฎุทุงุก (ูุง ุงุญุชูุงุทูุงุช ุตุงูุชุฉ)
- [x] ุชุบููุฑุงุช ุงูุนูุงุฑ ุชููุน ุงูุญูุธ ุจุฏูู ุฅุนุงุฏุฉ ุญุณุงุจ
- [x] ูุฒุงููุฉ Stripe ุชูุญุฏุซ payment intents ุบูุฑ ุงููุฏููุนุฉ
- [x] ูุฒุงููุฉ Stripe ุชูุณุฌู ุชุญุฐูุฑุงุช ููุทูุจุงุช ุงููุฏููุนุฉ

### ุงูุงุฎุชุจุงุฑ ุงููุฏูู ุงููุทููุจ:
- [ ] ุฅูุดุงุก ุทูุจ ุชุฌุฑูุจู ุจุฅุฌูุงูู ยฃ50.00
- [ ] ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชูุธูุฑ `totalGBP = 5000`
- [ ] ุชุบููุฑ ุทูุงุจู ุงูุนูุงุฑุ ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุณุนุฑ
- [ ] ุงูุชุญูู ูู ุญูุธ ุงูุณุนุฑ ุงูุฌุฏูุฏ ุจุดูู ุตุญูุญ ุจุงูุจูุณ
- [ ] ูุญุต ููุญุฉ Stripe ูุชุญุฏูุซ payment intent
- [ ] ุงุฎุชุจุงุฑ ูุน ุทูุจ ูุฏููุนุ ุงูุชุญูู ูู ุนุฑุถ ุงูุชุญุฐูุฑ

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ ุงูุฑุฆูุณูุฉ

### Frontend:
- `apps/web/src/components/admin/OrderDetailDrawer.tsx`
  - ุฅุตูุงุญ ูุนุงูุฌุฉ ูุญุฏุฉ ุงูุนููุฉ
  - ุฅุถุงูุฉ ุงูุชุญูู ูู ูุดู ุฅุนุงุฏุฉ ุงูุญุณุงุจ
  - ุฅุฒุงูุฉ ุงูุฑููุฒ ุงูุจุฑูุฏูุฉ ุงูุซุงุจุชุฉ
  - ุฅุถุงูุฉ ุนุฑุถ ุงูุชุญุฐูุฑุงุช

### Backend:
- `apps/web/src/app/api/admin/orders/[code]/route.ts`
  - ุฅุถุงูุฉ ุฏุนู ุชุญุฏูุซ totalGBP
  - ุชูููุฐ ูุฒุงููุฉ Stripe
  - ุฅุถุงูุฉ ูุธุงู ุงูุชุญุฐูุฑุงุช
  - ุชุญุณูู ุชุณุฌูู Audit

---

## ๐ ููุงุญุธุงุช ุงููุดุฑ

### ูุจู ุงููุดุฑ:
1. โ ุชุดุบูู linter: `eslint . --max-warnings=0`
2. โ ูุญุต ุงูุฃููุงุน: `tsc --noEmit`
3. โ ุงุฎุชุจุงุฑ ุงูุจูุงุก: `next build`
4. โ๏ธ ูุฑุงุฌุนุฉ ุงูุทูุจุงุช ุงูููุฌูุฏุฉ ููุฃุณุนุงุฑ ุงููุงุณุฏุฉ (ูุญุต ูุฏูู)

### ุจุนุฏ ุงููุดุฑ:
1. ูุฑุงูุจุฉ audit logs ููุจุญุซ ุนู `price_change_after_payment`
2. ุงุฎุชุจุงุฑ ุชุฏูู ุชุญุฏูุซ ุณุนุฑ ุงููุณุคูู ุนูู staging
3. ุงูุชุญูู ูู ูุนุงูุฌุฉ Stripe webhooks ุจุดูู ุตุญูุญ
4. ูุญุต Sentry ูุฃููุงุท ุงูุฃุฎุทุงุก ุงูุฌุฏูุฏุฉ

---

## ๐ ูุนูููุงุช ุงูุฏุนู

ููุฃุณุฆูุฉ ุญูู ูุฐุง ุงูุฅุตูุงุญ:
- **ุงููุงุชู:** 01202129764
- **ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:** support@speedy-van.co.uk

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2025-11-07  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุฅูุชุงุฌ  
**ุชูุช ุงููุฑุงุฌุนุฉ ูู ูุจู:** ุงููุทูุฑ ุงูุฑุฆูุณู  
**ุชูุช ุงูููุงููุฉ ูู ูุจู:** ุงููุงุฆุฏ ุงูุชููู

